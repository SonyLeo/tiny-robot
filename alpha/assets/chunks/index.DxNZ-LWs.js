import{d as xe,p as D,h as E,q as ne,a1 as at,c as T,o as m,j as N,G as U,w as pe,e as q,r as re,T as De,n as ae,b as Y,k as _,ax as lt,a as Je,t as ue,N as We,P as te,aQ as ot,aB as st,aC as it,v as rt,x as ut,F as fe,B as be,K as we,a0 as dt,aO as ct,C as pt}from"./framework.DrGfhPAt.js";import{I as ft}from"./index.DEUmgi2i.js";import{T as Ae}from"./index.DEgDKdua.js";import{K as vt}from"./index2.BzGNBP-0.js";import{p as yt,I as gt,u as ht,x as mt,l as wt,i as bt,z as xt}from"./tiny-robot-svgs.BbDZZ-ON.js";import{s as _e}from"./plugin-vue_export-helper.lGy7RumW.js";import{e as _t}from"./utils.nxwM3ABj.js";function St(i,u){const o=D(i.modelValue||i.defaultValue||""),g=D(null);ne(()=>i.modelValue,v=>{v!==void 0&&v!==o.value&&(o.value=v)}),ne(()=>o.value,v=>{u("update:modelValue",v)});const p=v=>{o.value=v,u("update:modelValue",v)},y=v=>{v==null||v.preventDefault();const b=o.value;!i.disabled&&!i.loading&&b.trim()&&u("submit",b)},l=()=>{o.value="",u("update:modelValue",""),u("clear")},c=D(!1);return{inputValue:o,inputWrapper:g,isComposing:c,handleChange:p,handleSubmit:y,handleClear:l,clearInput:()=>{l()}}}function Ct(i,u,o,g,p,y,l,c,v,b,B,L,w,F,G,W){const O=()=>{L.value&&(G!=null&&G.value&&(W==null||W()),u("submit",o.value.trim()))},h=(f,k)=>{if(f.key!=="Enter")return!1;switch(k){case"enter":return!f.shiftKey&&!f.ctrlKey&&!f.metaKey;case"ctrlEnter":return(f.ctrlKey||f.metaKey)&&!f.shiftKey;case"shiftEnter":return f.shiftKey&&!f.ctrlKey&&!f.metaKey;default:return!1}};return{handleKeyPress:f=>{if(!g.value){if(f.key==="Enter"&&f.shiftKey&&(w==null?void 0:w.value)==="single"&&F){f.preventDefault(),F();const k=f.target,X=k.selectionStart,K=o.value;o.value=K.substring(0,X)+`
`+K.substring(X),setTimeout(()=>{k.selectionStart=k.selectionEnd=X+1},0);return}if(f.key==="Tab"&&y.value&&l.value){f.preventDefault(),c();return}if(y.value){if(f.key==="ArrowDown"){f.preventDefault(),b("down");return}if(f.key==="ArrowUp"){f.preventDefault(),b("up");return}if(f.key==="Enter"&&l.value){f.preventDefault(),c();return}}if(f.key==="Escape"){y.value?(v(),f.preventDefault()):p.isRecording&&(B(),f.preventDefault()),u("escape-press");return}h(f,i.submitType)&&(f.preventDefault(),L.value&&O())}},triggerSubmit:O}}function kt(i){const u=ot({isRecording:!1,isSupported:typeof window<"u"&&"webkitSpeechRecognition"in window||"SpeechRecognition"in window,error:void 0}),o=u.isSupported?new(window.webkitSpeechRecognition||window.SpeechRecognition):void 0;o!==void 0&&(o.continuous=i.continuous??!1,o.interimResults=i.interimResults??!0,o.lang=i.lang??navigator.language,o.onstart=()=>{var l;u.isRecording=!0,u.error=void 0,(l=i.onStart)==null||l.call(i)},o.onend=()=>{var l;u.isRecording=!1,(l=i.onEnd)==null||l.call(i)},o.onresult=l=>{var c,v;const b=Array.from(l.results).map(B=>B[0].transcript).join("");l.results[0].isFinal?(c=i.onFinal)==null||c.call(i,b):(v=i.onInterim)==null||v.call(i,b)},o.onerror=l=>{var c;u.error=new Error(l.error),u.isRecording=!1,(c=i.onError)==null||c.call(i,u.error)});const g=()=>{var l;if(!o){const c=new Error("浏览器不支持语音识别");u.error=c,(l=i.onError)==null||l.call(i,c);return}if(u.isRecording){try{o.stop(),setTimeout(()=>{try{o.start()}catch(c){y(c)}},100)}catch(c){y(c)}return}try{o.start()}catch(c){y(c)}},p=()=>{if(o&&u.isRecording)try{o.stop()}catch(l){y(l)}},y=l=>{var c;u.error=l instanceof Error?l:new Error("语音识别操作失败"),u.isRecording=!1,(c=i.onError)==null||c.call(i,u.error)};return{speechState:u,start:g,stop:p}}function Tt(i,u,o,g,p,y){const l=D(!1),c=D(-1),v=D(-1),b=D(null),B=D(""),L=D(!1),w=E(()=>{var x,j;if(!((x=i.value)!=null&&x.length))return"";const J=b.value==="mouse"?v.value:c.value;return((j=i.value[J])==null?void 0:j.content)||""}),F=x=>{B.value=x,L.value=!0},G=()=>{B.value="",L.value=!1},W=x=>{const j=x||w.value;if(!j||!u.value){G();return}const J=j.substring(u.value.length);j.toLowerCase().startsWith(u.value.toLowerCase())&&J?F(J):G()},O=()=>{c.value=-1,v.value=-1,b.value=null},h=()=>{l.value=!0,W()},f=()=>{l.value=!1,O(),G()},k=E(()=>{var x;return o.value?!0:!!(u.value&&((x=i.value)==null?void 0:x.length)>0&&!g.value)}),X=x=>{f(),u.value=x,p(x),y(x)},K=()=>{w.value&&X(w.value)},Z=x=>{!l.value||!i.value||(b.value="keyboard",c.value===-1?c.value=x==="down"?0:i.value.length-1:x==="down"?c.value=(c.value+1)%i.value.length:c.value=(c.value-1+i.value.length)%i.value.length,W())},ve=x=>{i.value&&(b.value="mouse",v.value=x,W())},z=()=>{i.value&&(v.value=-1,c.value!==-1?b.value="keyboard":b.value=null,W())};return ne(k,x=>{x?l.value||h():l.value&&f()}),{isPopupVisible:l,openPopup:h,closePopup:f,autoCompleteText:B,showTabIndicator:L,syncAutoComplete:W,activeSuggestion:w,activeKeyboardIndex:c,activeMouseIndex:v,navigateWithKeyboard:Z,handleMouseEnter:ve,handleMouseLeave:z,applySuggestion:X,confirmSelection:K}}const Ot={class:"action-buttons"},It={class:"action-buttons__submit-content"},Rt={key:0,class:"action-buttons__cancel-text"},$t=xe({__name:"ActionButtons",props:{loading:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},showClear:{type:Boolean,default:!0},hasContent:{type:Boolean,default:!1},buttonGroup:{},allowSpeech:{type:Boolean,default:!1},speechStatus:{default:()=>({isRecording:!1,isSupported:!1})},allowFiles:{type:Boolean,default:!1},submitType:{default:"enter"},showShortcuts:{type:Boolean},isOverLimit:{type:Boolean,default:!1},stopText:{default:void 0}},emits:["clear","toggle-speech","submit","cancel","trigger-select"],setup(i,{emit:u}){const o=i,g=u,p=E(()=>{var h,f;const k=(f=(h=o.buttonGroup)==null?void 0:h.file)==null?void 0:f.tooltips;if(typeof k=="string"&&k)return()=>k;if(typeof k=="function")return k}),y=E(()=>{var h,f;const k=(f=(h=o.buttonGroup)==null?void 0:h.submit)==null?void 0:f.tooltips;if(typeof k=="string"&&k)return()=>k;if(typeof k=="function")return k}),l=E(()=>o.allowSpeech),c=E(()=>o.speechStatus.isRecording),v=E(()=>o.disabled),b=E(()=>{var h,f;return v.value||o.isOverLimit||((f=(h=o.buttonGroup)==null?void 0:h.submit)==null?void 0:f.disabled)}),B=E(()=>o.allowFiles||o.allowSpeech||o.showClear),L=()=>{v.value||g("clear")},w=()=>{if(!v.value){const h=!o.speechStatus.isRecording;g("toggle-speech",h)}},F=()=>{b.value||g("submit")},G=()=>{v.value||g("cancel")},W=E(()=>{var h,f;return v.value||((f=(h=o.buttonGroup)==null?void 0:h.file)==null?void 0:f.disabled)}),O=()=>{W.value||g("trigger-select")};return(h,f)=>(m(),T("div",Ot,[B.value?(m(),T("div",{key:0,class:"action-buttons__utility",style:We({"padding-right":h.hasContent||h.loading?"0":"6px"})},[h.allowFiles&&!h.loading?(m(),Y(_(Ae),{key:0,effect:"light",placement:"top","render-content":p.value,"visible-arrow":!1},{default:pe(()=>[N("div",{class:"action-buttons__button",onClick:O},[U(_(yt),{class:ae(["action-buttons__icon","action-buttons__icon--upload",{"is-disabled":W.value}]),alt:"上传文件"},null,8,["class"])])]),_:1},8,["render-content"])):q("",!0),l.value&&!h.loading?(m(),T("div",{key:1,class:ae(["action-buttons__button",{"is-recording":c.value}]),onClick:w},[c.value?(m(),Y(_(gt),{key:1,class:"action-buttons__icon action-buttons__icon--recording",alt:"语音中"})):(m(),Y(_(ht),{key:0,class:"action-buttons__icon",alt:"录音"}))],2)):q("",!0),h.showClear?(m(),Y(_(Ae),{key:2,content:"清空内容",placement:"top"},{default:pe(()=>[N("div",{class:"action-buttons__button",onClick:L},[U(_(mt),{class:"action-buttons__icon action-buttons__icon--clear"})])]),_:1})):q("",!0)],4)):q("",!0),h.hasContent||h.loading?(m(),T("div",{key:1,class:"action-buttons__button action-buttons__submit",onClick:f[0]||(f[0]=k=>h.loading?G():F())},[N("div",It,[h.loading?(m(),T("div",{key:1,class:ae(["action-buttons__cancel",{"action-buttons__cancel--icon-only":!h.stopText}])},[U(_(wt),{class:"action-buttons__icon action-buttons__icon--cancel",alt:"停止"}),h.stopText?(m(),T("span",Rt,ue(h.stopText),1)):q("",!0)],2)):(m(),Y(_(Ae),{key:0,effect:"light",placement:"top","render-content":y.value,"visible-arrow":!1},{default:pe(()=>[U(_(bt),{class:ae(["action-buttons__icon","action-buttons__icon--send",{"is-disabled":b.value}]),alt:"发送"},null,8,["class"])]),_:1},8,["render-content"]))])])):q("",!0)]))}}),Qe=_e($t,[["__scopeId","data-v-ee42294d"]]);function Et(i,u={}){let o=[],g=[],p=i;return{commit:y=>{var l;o.push(p),p=y,g.length&&((l=u.onRemoveHistory)==null||l.call(u,g)),g=[]},undo:()=>o.length?(g.push(p),p=o.pop(),p):null,redo:()=>g.length?(o.push(p),p=g.pop(),p):null,clear:()=>{var y,l;o.length&&((y=u.onRemoveHistory)==null||y.call(u,o)),g.length&&((l=u.onRemoveHistory)==null||l.call(u,g)),o=[],g=[]},get:()=>p}}const Bt=["data-id","data-type"],Lt=["data-id","data-type"],Kt=xe({inheritAttrs:!1,__name:"Block",props:{id:{},type:{},content:{},readonly:{type:Boolean},asChild:{type:Boolean}},setup(i){const u=i,o=ct();return(g,p)=>{const y=pt("Block",!0);return u.type!=="block"?(m(),T("span",we({key:0,"data-id":u.id,"data-type":u.type},_(o)),ue(u.content),17,Bt)):(m(),T(fe,{key:1},[u.asChild?(m(!0),T(fe,{key:0},be(u.content,l=>(m(),Y(y,we({key:`${l.id}-${l.type}`},{ref_for:!0},l),null,16))),128)):(m(),T("span",we({key:1,"data-id":u.id,"data-type":u.type},_(o)),[(m(!0),T(fe,null,be(u.content,l=>(m(),Y(y,we({key:`${l.id}-${l.type}`},{ref_for:!0},l),null,16))),128))],16,Lt))],64))}}}),Mt=_e(Kt,[["__scopeId","data-v-13862606"]]),Vt={class:"editor-container"},Fe="​",At=xe({__name:"TemplateEditor",props:{modelValue:{default:()=>[]},modelModifiers:{}},emits:st(["submit"],["update:modelValue"]),setup(i,{expose:u,emit:o}){const g=typeof window.ShadowRoot.prototype.getSelection=="function",p=typeof window.Selection.prototype.getComposedRanges=="function";function y(){const e=navigator.userAgent;return e.includes("Safari")&&!e.includes("Chrome")&&!e.includes("Chromium")&&!e.includes("CriOS")}const l=y(),c=()=>Math.random().toString(36).substring(2,15),v=Fe,b=Fe,B=Fe,L=it(i,"modelValue"),w=o,F=D(0),G=e=>e.map(n=>({id:n.id||c(),...n.type==="template"?{...n,prefix:b,suffix:B}:n})),W=e=>e.map(n=>({id:n.id,type:n.type,content:n.content})),O=D(G(L.value||[])),h=e=>{O.value=e},f=E(()=>{const e=[],n=[],t=O.value;if(t.length>=2){const s=t[0],d=t[1];s.type==="text"&&s.content.length===0&&d.type==="template"&&e.push({...s,content:v});const S=t[t.length-1],I=t[t.length-2];S.type==="text"&&S.content.length===0&&I.type==="template"&&n.push({...S,content:v})}t.length>0&&t[0].type==="template"&&e.push({type:"text",content:v,id:c()}),t.length>0&&t[t.length-1].type==="template"&&n.push({type:"text",content:v,id:c()});const r=new RegExp(v,"g");return t.length>0&&(t[0].content!==v&&(t[0].content=t[0].content.replace(r,"")),t[t.length-1].content!==v&&(t[t.length-1].content=t[t.length-1].content.replace(r,""))),e.concat(t).concat(n)}),k=E(()=>O.value.map(e=>e.type==="template"?[{id:e.id,type:"prefix",content:e.prefix},{id:e.id,type:"template",content:e.content},{id:e.id,type:"suffix",content:e.suffix}]:[e]).flat()),X=E(()=>f.value.map(e=>e.type==="text"?e:l?{id:e.id,type:"block",asChild:!0,content:[{id:e.id,type:"prefix",content:e.prefix},{id:e.id,type:"block",content:[{id:e.id,type:"template",content:e.content},{id:e.id,type:"suffix",content:e.suffix}]}]}:{id:e.id,type:"block",asChild:!0,content:[{id:e.id,type:"block",content:[{id:e.id,type:"prefix",content:e.prefix},{id:e.id,type:"template",content:e.content}]},{id:e.id,type:"suffix",content:e.suffix}]})),K=D(null),Z=e=>{const n=Date.now(),t=JSON.stringify(e);return`${n}:${t}`},ve=e=>{const n=parseInt(e.slice(0,13)),t=JSON.parse(e.slice(14));return{timestamp:n,data:t}},z=new Map,x=Et(Z(O.value),{onRemoveHistory:e=>{for(const n of e)z.delete(n)}});ne(()=>L.value,e=>{const n=G(e||[]);if(JSON.stringify(n)!==JSON.stringify(O.value)){if(K.value){const t=de(K.value);t&&z.set(x.get(),H(t))}h(n),x.commit(Z(O.value))}},{deep:!0});const j=(e,n=document.body)=>n.contains(e)?e instanceof HTMLElement&&e.dataset.id?e:e.parentElement?j(e.parentElement,n):null:null,J=e=>e===K.value,de=e=>{const n=window.getSelection();if(!n)return null;const t=n.rangeCount>0?n.getRangeAt(0):null,r=e.getRootNode();if(!(r instanceof ShadowRoot))return t;if(p){const s=n.getComposedRanges(l?r:{shadowRoots:[r]});return(s==null?void 0:s[0])??null}if(g){const s=r.getSelection();return s.rangeCount>0?s.getRangeAt(0):null}return t},Se=(e,n)=>{var t;if(!e.firstChild||e.firstChild.nodeType!==Node.TEXT_NODE)return{node:e,offset:0};const r=((t=e.firstChild.textContent)==null?void 0:t.length)??0;return{node:e.firstChild,offset:Math.min(n,r)}},A=(e,n,t,r)=>{const s=window.getSelection();if(!s)return;const{node:d,offset:S}=Se(e,n);if(!t){s.setBaseAndExtent(d,S,d,S);return}const{node:I,offset:P}=Se(t,r??0);s.setBaseAndExtent(d,S,I,P)},ee=(e,n)=>{const t=c(),r={id:t,type:"text",content:e};if(n){const s=O.value.findIndex(d=>d.id===n);s!==-1?(h(O.value.slice(0,s+1).concat(r).concat(O.value.slice(s+1))),x.commit(Z(O.value))):console.warn(`can not find item with id: ${n}`)}else h([r].concat(O.value)),x.commit(Z(O.value));te(()=>{var s;const d=(s=K.value)==null?void 0:s.querySelector(`[data-id="${t}"][data-type="text"]`);d&&A(d,e.length)}),L.value=W(O.value)},le=D({hasStarted:!1,range:null}),Be=e=>{var n;const t=e;e.preventDefault();const{inputType:r}=t,s=(t.data||((n=t.dataTransfer)==null?void 0:n.getData("text/plain"))||"").replace(b,"").replace(B,""),d=t.getTargetRanges()[0];if(!d){console.warn("range is null",d);return}const S=["insertText","insertFromPaste","insertReplacementText","deleteContentBackward","deleteContentForward","deleteWordBackward","deleteWordForward","deleteSoftLineBackward","deleteSoftLineForward","deleteByCut"],I=de(K.value);if(S.includes(r)){if(s&&J(d.startContainer)&&J(d.endContainer)){I&&z.set(x.get(),H(I)),ee(s);return}const P=H(d);P.startId&&P.endId?(I&&z.set(x.get(),H(I)),Ce(P,r,s)):console.warn("range is not valid, range:",P)}else r==="insertCompositionText"&&le.value.hasStarted&&(le.value={hasStarted:!1,range:H(d)})},H=e=>{const n=j(e.startContainer,K.value),t=j(e.endContainer,K.value);return{collapsed:e.collapsed,endContainer:e.endContainer,endId:t==null?void 0:t.dataset.id,endEl:t,endOffset:e.endOffset,endType:t==null?void 0:t.dataset.type,startContainer:e.startContainer,startId:n==null?void 0:n.dataset.id,startEl:n,startOffset:e.startOffset,startType:n==null?void 0:n.dataset.type}},ye=(e,n,t,r)=>e.slice(0,t)+n+e.slice(r),Ce=(e,n,t)=>{const r=he(e);if(!Array.isArray(r)||r.length===0)return;const s=Le(r,e,n,t);if(s.some(R=>R.tag==="new")){const{afterId:R,content:$}=s[0];ee($,R);return}const d=s,S=[];for(const[R,$]of d.entries()){const V=O.value.find(a=>a.id===$.id),Q=R===0?t:"";V?V.type==="text"?V.content=ye(V.content,Q,$.startOffset,$.endOffset):V.type==="template"?$.type==="prefix"||$.type==="suffix"?$.startOffset===0&&$.endOffset===1&&Q.length===0?V[$.type]="":console.warn(`${$.type} can not be inserted text. it only can be deleted`,$):$.startOffset<0||$.endOffset>V.content.length?S.push(V.id):V.content=ye(V.content,Q,$.startOffset,$.endOffset):console.warn("dataItem.type is not text or template",V):console.warn("can not find dataItem",$)}let I=O.value.filter(R=>!S.includes(R.id));I=I.filter(R=>!(R.type==="template"&&[R.prefix,R.suffix,R.content].join("").length===0));const P=new Set;I.forEach((R,$,V)=>{if(V.length>=2){if($===0||$===1){const Q=V[0],a=V[1];if(Q.type==="text"&&Q.content.length===0&&a.type==="template")return}if($===V.length-2||$===V.length-1){const Q=V[V.length-1],a=V[V.length-2];if(Q.type==="text"&&Q.content.length===0&&a.type==="template")return}}R.type==="text"&&R.content.length===0&&P.add(R.id)}),I=I.filter(R=>!P.has(R.id));for(const R of I.filter($=>$.type==="template"))R.prefix.length===0&&(R.prefix=b),R.suffix.length===0&&(R.suffix=B);h(I),x.commit(Z(O.value)),d.length>0&&ge(d,t),L.value=W(O.value)},ge=(e,n)=>{const t=e[0],r=`[data-id="${t.id}"][data-type="${t.type}"]`,s=e.slice(1).map(d=>`[data-id="${d.id}"][data-type="${d.type}"]`);te(()=>{var d,S;const I=(d=K.value)==null?void 0:d.querySelector(r);if(I)A(I,t.startOffset+n.length);else if(n.length===0)for(const P of s){const R=(S=K.value)==null?void 0:S.querySelector(P);if(R){A(R,0);break}}else console.warn(`can not find el with selector: ${r}`)})},he=e=>{const n=k.value.findIndex(S=>S.id===e.startId&&S.type===e.startType),t=k.value.findIndex(S=>S.id===e.endId&&S.type===e.endType);if(n===-1||t===-1||n>t)return console.warn("startIndex or endIndex is -1, or startIndex > endIndex. ",{range:e}),null;const r=k.value[n],s=k.value[t];if(n===t)return[{id:r.id,type:r.type,startOffset:e.startOffset,endOffset:e.endOffset}];const d=[{id:r.id,type:r.type,startOffset:e.startOffset,endOffset:r.content.length}];for(let S=n+1;S<t;S++){const I=k.value[S];d.push({id:I.id,type:I.type,startOffset:0,endOffset:I.content.length})}return d.push({id:s.id,type:s.type,startOffset:0,endOffset:e.endOffset}),d},Le=(e,n,t,r)=>{const s=e[0];if(s.type!=="prefix"&&s.type!=="suffix")return e;if(e.length===1){if(n.collapsed)if(n.startOffset===0){const d=me(s,r);return d?[d]:[]}else{const d=oe(s,r);return d?[d]:[]}if(t.startsWith("insert"))if(l){const d=me(s,r);return d?[d]:[]}else{const d=oe(s,r);return d?[d]:[]}if(t.startsWith("delete")){if(t.includes("Backward")){const d=me(s,r,1);return d?[d]:[]}else if(t.includes("Forward")){const d=oe(s,r,1);return d?[d]:[]}}}return r.length>0?e.slice(1):e},me=(e,n,t=0)=>{const r=k.value.findIndex(s=>s.id===e.id&&s.type===e.type);if(r>0){const s=k.value[r-1],{id:d,type:S,content:I}=s;if(S==="text"||S==="template")return{id:d,type:S,startOffset:I.length-t,endOffset:I.length};if(n.length>0)return{tag:"new",afterId:d,type:"text",content:n};if(console.warn("the previous item is not text or template",{current:e,previous:s}),t===1)return{...e,endOffset:e.startOffset}}else return n.length>0?{tag:"new",type:"text",content:n}:(console.warn("the previous item of current is not found",{current:e}),null);return e},oe=(e,n,t=0)=>{const r=k.value.findIndex(s=>s.id===e.id&&s.type===e.type);if(r<k.value.length-1){const s=k.value[r+1],{id:d,type:S}=s;if(S==="text"||S==="template")return{id:d,type:S,startOffset:0,endOffset:0+t};if(n.length>0)return{tag:"new",afterId:e.id,type:"text",content:n};if(console.warn("the next item is not text or template",{current:e,next:s}),t===1)return{...e,startOffset:e.endOffset}}else return n.length>0?{tag:"new",afterId:e.id,type:"text",content:n}:(console.warn("the next item of current is not found",{current:e}),null);return e},ke=()=>{le.value={hasStarted:!0,range:null}},Te=e=>{const n=le.value.range;n?(e.data&&J(n.startContainer)&&J(n.endContainer)?(z.set(x.get(),H(n)),ee(e.data)):n.startId&&n.endId?(z.set(x.get(),H(n)),Ce(n,"insertCompositionText",e.data)):console.warn("range is not valid, range:",n),F.value++):console.warn("range is null, compositionEnd:",e),le.value={hasStarted:!1,range:null}},se=(()=>{const e=navigator.userAgent.toLowerCase();return/macintosh|mac os x|iphone|ipad|ipod/.test(e)})(),ce=e=>{const n=se&&e.metaKey&&!e.shiftKey&&e.key.toLowerCase()==="z"||!se&&e.ctrlKey&&!e.shiftKey&&e.key.toLowerCase()==="z",t=se&&e.metaKey&&e.shiftKey&&e.key.toLowerCase()==="z"||!se&&e.ctrlKey&&(e.key.toLowerCase()==="y"||e.shiftKey&&e.key.toLowerCase()==="z"),r=e.key.toLowerCase()==="enter";if(n){e.preventDefault();const s=de(K.value);s&&z.set(x.get(),H(s));const d=x.undo();d&&Oe(d)}if(t){e.preventDefault();const s=x.redo();s&&Oe(s)}r&&(e.preventDefault(),w("submit"))},Oe=e=>{const{data:n}=ve(e);if(h(n),z.has(e)){const t=z.get(e);te(()=>{const r=K.value.querySelector(`[data-id="${t.startId}"][data-type="${t.startType}"]`),s=K.value.querySelector(`[data-id="${t.endId}"][data-type="${t.endType}"]`);r&&A(r,t.startOffset,s,t.endOffset)})}L.value=W(O.value)},ie=(e,n)=>{var t,r;const s=(t=K.value)==null?void 0:t.querySelector(`[data-id="${e}"][data-type="${n}"]`);if(!s)return;const d=((r=s.textContent)==null?void 0:r.length)||0;A(s,d)},Ke=()=>{K.value&&te(()=>{const e=O.value,n=e.find(t=>t.type==="template");n&&ie(n.id,"template"),e.every(t=>t.type==="text")&&e.length===1&&ie(e[0].id,"text")})},Me=()=>{x.clear(),z.clear()},Ie=()=>{if(!K.value||le.value.range)return;const e=de(K.value);if(e!=null&&e.collapsed&&f.value.length>0){const n=H(e),t=f.value[0];if(n.startEl&&n.startId===t.id&&n.startOffset===0&&t.content===v&&t.type==="text"){A(n.startEl,1);return}const r=f.value[f.value.length-1];if(n.endEl&&n.endId===r.id&&n.endOffset===1&&r.content===v&&r.type==="text"){A(n.endEl,0);return}}};return rt(()=>{document.addEventListener("selectionchange",Ie)}),ut(()=>{document.removeEventListener("selectionchange",Ie)}),u({clearHistory:Me,activateFirstField:Ke}),(e,n)=>(m(),T("div",Vt,[(m(),T("div",{contenteditable:"true",ref_key:"editorRef",ref:K,key:F.value,class:"editor",onBeforeinput:Be,onCompositionstart:ke,onCompositionend:Te,onKeydown:ce},[(m(!0),T(fe,null,be(X.value,t=>(m(),Y(Mt,we({key:`${t.id}-${t.type}`},{ref_for:!0},t),null,16))),128))],32))]))}}),Ft=_e(At,[["__scopeId","data-v-5fda773e"]]),Ue=(i,u)=>{if(!u.length)return[{text:i,isMatch:!1}];const o=[];for(const l of u){if(!l)continue;let c=0;const v=i.toLowerCase(),b=l.toLowerCase();for(;;){const B=v.indexOf(b,c);if(B===-1)break;o.push({start:B,end:B+l.length}),c=B+1}}if(o.length===0)return[{text:i,isMatch:!1}];o.sort((l,c)=>l.start-c.start);const g=[];for(const l of o)if(g.length===0)g.push(l);else{const c=g[g.length-1];l.start<=c.end?c.end=Math.max(c.end,l.end):g.push(l)}const p=[];let y=0;for(const l of g)y<l.start&&p.push({text:i.substring(y,l.start),isMatch:!1}),p.push({text:i.substring(l.start,l.end),isMatch:!0}),y=l.end;return y<i.length&&p.push({text:i.substring(y),isMatch:!1}),p},Dt=(i,u)=>!u||!i?[{text:i,isMatch:!1}]:Ue(i,[u]),Wt=(i,u)=>{const{content:o,highlights:g}=i;return typeof g=="function"?g(o,u):Array.isArray(g)?Ue(o,g):Dt(o,u)},qt=["onMouseenter","onMousedown"],Gt={class:"suggestion-list__text"},zt=xe({__name:"SuggestionList",props:{show:{type:Boolean},suggestions:{},popupStyle:{},activeKeyboardIndex:{},activeMouseIndex:{},inputValue:{}},emits:["select","mouse-enter","mouse-leave"],setup(i,{emit:u}){const o=i,g=u,p=D(null),y=b=>b===o.activeKeyboardIndex||b===o.activeMouseIndex,l=b=>{g("mouse-enter",b)},c=()=>{g("mouse-leave")},v=b=>{g("select",b)};return ne(()=>o.activeKeyboardIndex,b=>{if(b!==-1&&p.value){const B=p.value.children[b];B&&B.scrollIntoView({block:"nearest"})}}),(b,B)=>(m(),Y(De,{name:"tiny-sender-slide-up"},{default:pe(()=>[o.show&&o.suggestions.length?(m(),T("div",{key:0,ref_key:"suggestionsListRef",ref:p,class:"suggestion-list",style:We(o.popupStyle)},[(m(!0),T(fe,null,be(o.suggestions,(L,w)=>(m(),T("div",{key:w,class:ae(["suggestion-list__item",{highlighted:y(w)}]),onMouseenter:F=>l(w),onMouseleave:c,onMousedown:dt(F=>v(L.content),["prevent"])},[U(_(xt),{class:"suggestion-list__icon"}),N("span",Gt,[(m(!0),T(fe,null,be(_(Wt)(L,o.inputValue),(F,G)=>(m(),T("span",{key:G,class:ae({"suggestion-list__text--match":F.isMatch,"suggestion-list__text--normal":!F.isMatch})},ue(F.text),3))),128))])],42,qt))),128))],4)):q("",!0)]),_:1}))}}),Pt=_e(zt,[["__scopeId","data-v-e0ec9fe3"]]),Nt=["data-theme"],jt={class:"tiny-sender__container"},Ht={key:0,class:"tiny-sender__header-slot"},Jt={key:0,class:"tiny-sender__prefix-slot"},Qt={class:"tiny-sender__content-area"},Ut={key:0,class:"tiny-sender__decorative-content"},Xt={key:2,class:"tiny-sender__input-field-wrapper"},Yt={key:0,class:"tiny-sender__completion-placeholder"},Zt={class:"user-input-mirror"},en={key:0,class:"tiny-sender__tab-hint"},tn={key:1,class:"tiny-sender__actions-slot"},nn={class:"tiny-sender__footer-left"},an={class:"tiny-sender__footer-right"},ln={class:"real-word-length"},on={key:1,class:"tiny-sender__toolbar"},sn={class:"tiny-sender__buttons-container"},rn={key:1,class:"tiny-sender__footer-slot"},un=xe({__name:"index",props:{autofocus:{type:Boolean,default:!1},autoSize:{type:[Boolean,Object],default:()=>({minRows:1,maxRows:3})},allowSpeech:{type:Boolean,default:!0},allowFiles:{type:Boolean,default:!1},clearable:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},defaultValue:{},loading:{type:Boolean,default:!1},modelValue:{default:""},mode:{default:"single"},maxLength:{default:1/0},buttonGroup:{},submitType:{default:"enter"},speech:{type:[Boolean,Object]},placeholder:{default:"请输入内容..."},showWordLimit:{type:Boolean,default:!1},suggestions:{default:()=>[]},suggestionPopupWidth:{default:400},theme:{default:"light"},templateData:{default:()=>[]},stopText:{default:""}},emits:["update:modelValue","update:templateData","submit","clear","speech-start","speech-end","speech-interim","speech-error","suggestion-select","focus","blur","escape-press","cancel","reset-template","files-selected"],setup(i,{expose:u,emit:o}){var g;const p=i,y=o,l=D(null),c=D(null),v=D(null),b=D(null),B=D(null),L=E(()=>p.templateData&&p.templateData.length>0),{inputValue:w,isComposing:F,clearInput:G}=St(p,y),W=E(()=>!!w.value.trim()),O=E(()=>{var a,C;return!(p.disabled||p.loading||!W.value||ce.value||(C=(a=p.buttonGroup)==null?void 0:a.submit)!=null&&C.disabled)}),{isPopupVisible:h,activeSuggestion:f,activeKeyboardIndex:k,activeMouseIndex:X,autoCompleteText:K,showTabIndicator:Z,syncAutoComplete:ve,closePopup:z,applySuggestion:x,confirmSelection:j,navigateWithKeyboard:J,handleMouseEnter:de,handleMouseLeave:Se}=Tt(E(()=>p.suggestions),w,F,L,a=>y("update:modelValue",a),a=>y("suggestion-select",a)),A=D(p.mode),ee=D(!1),le=()=>{A.value==="single"&&(A.value="multiple",te(()=>{setTimeout(()=>{const a=document.querySelector(".tiny-textarea__inner");if(a){a.style.whiteSpace="pre-wrap";const C=w.value.length;a.focus(),a.setSelectionRange(C,C)}},50)}))},Be=(a,C)=>{const M=document.createElement("span");M.style.visibility="hidden",M.style.position="absolute",M.style.whiteSpace="nowrap",M.style.font=C,M.textContent=a,document.body.appendChild(M);const Re=M.offsetWidth;return document.body.removeChild(M),Re},H=()=>{var a,C,M;if(p.mode!=="single"||!l.value||ee.value||!c.value||!b.value)return;const Re=c.value.querySelector(".tiny-sender__content-area");if(!Re)return;const Ve=((C=(a=l.value)==null?void 0:a.querySelector)==null?void 0:C.call(a,".tiny-input__inner"))||Re.querySelector(".tiny-input__inner"),qe=B.value||c.value.querySelector(".tiny-sender__buttons-container");if(!Ve){console.warn("Cannot find input element for overflow check");return}const Ge=Ve.getBoundingClientRect(),ze=qe==null?void 0:qe.getBoundingClientRect();if(Ge.width===0){setTimeout(()=>H(),50);return}const Xe=window.getComputedStyle(Ve).font,Ye=Be(w.value,Xe),Pe=(M=c.value)==null?void 0:M.classList.contains("tr-sender-compact"),Ze=Pe?12:20,et=Ge.width,tt=(ze==null?void 0:ze.width)||0,Ne=et-tt-Ze,nt=Pe?50:80;Ye>Ne&&Ne>nt&&A.value==="single"&&(ee.value=!0,A.value="multiple",te(()=>{l.value?setTimeout(()=>{var je;const $e=(je=c.value)==null?void 0:je.querySelector(".tiny-textarea__inner");if($e){$e.style.whiteSpace="pre-wrap";const He=w.value.length;$e.focus(),$e.setSelectionRange(He,He)}ee.value=!1},300):ee.value=!1}))},ye=()=>{if(L.value&&v.value)P();else if(l.value)l.value.focus();else{const a=document.querySelector(".tiny-input__inner");a==null||a.focus()}},Ce=()=>{if(l.value)l.value.blur();else{const a=document.querySelector(".tiny-input__inner");a==null||a.blur()}},ge=()=>{var a;y("update:templateData",[]),(a=v.value)==null||a.clearHistory(),te(()=>{w.value===""&&(A.value=p.mode||"single"),setTimeout(()=>{ye()},50)})},he=()=>{var a;G(),L.value?ge():(a=c.value)==null||a.focus(),te(()=>{w.value===""&&(A.value=p.mode||"single")})},Le=a=>{const C=M=>M.type==="text"&&M.content==="​";if(a.length===0||a.every(C)){ge();return}y("update:templateData",a)};ne(()=>p.templateData,()=>{w.value=p.templateData.map(a=>a.content).join("")},{deep:!0});const me=E(()=>{const a=typeof p.speech=="object"?p.speech:{};return{...a,onStart:()=>y("speech-start"),onEnd:C=>y("speech-end",C),onInterim:C=>y("speech-interim",C),onFinal:C=>{if(a.autoReplace)w.value=C;else{const M=w.value;M&&C&&!M.endsWith(" ")&&!C.startsWith(" ")&&M.length>0?w.value=M+" "+C:w.value=M+C}y("speech-end",C)},onError:C=>{y("speech-error",C)}}}),{speechState:oe,start:ke,stop:Te}=kt(me.value),se=()=>{oe.isRecording?Te():ke()},ce=E(()=>p.maxLength!==1/0&&w.value.length>p.maxLength),{handleKeyPress:Oe,triggerSubmit:ie}=Ct(p,y,w,F,oe,h,f,j,z,J,se,O,A,le,L,ge),Ke=a=>{y("focus",a),w.value&&!L.value&&(h.value=!0)},Me=a=>{y("blur",a),z()},Ie=E(()=>A.value==="multiple"?"textarea":"text"),e=E(()=>({display:"flex",justifyContent:p.showWordLimit&&p.maxLength!==1/0?"space-between":"flex-end",alignItems:"center"})),n=at(),t=E(()=>!!n.decorativeContent),r=E(()=>p.disabled||t.value),s=E(()=>p.loading),d=E(()=>({"is-disabled":r.value,"is-loading":s.value,"is-auto-switching":ee.value})),S=E(()=>({width:_t(p.suggestionPopupWidth),maxWidth:"100%"})),I=()=>{F.value=!1};ne(w,()=>{te(H),w.value===""&&p.mode==="single"&&(A.value="single"),ve()}),ne(()=>L.value,a=>{a&&(A.value="multiple")});const P=()=>{v.value&&v.value.activateFirstField()},{accept:R="*",multiple:$=!0}=((g=p.buttonGroup)==null?void 0:g.file)||{},{open:V,files:Q}=vt({accept:R,multiple:$});return ne(Q,a=>{a&&a.length>0&&y("files-selected",Array.from(a))}),u({focus:ye,blur:Ce,clear:he,submit:ie,startSpeech:ke,stopSpeech:Te,activateTemplateFirstField:P}),(a,C)=>(m(),T("div",{ref_key:"senderRef",ref:c,class:ae(["tiny-sender",[d.value,`theme-${a.theme}`,`mode-${A.value}`]]),"data-theme":a.theme},[N("div",jt,[N("div",{class:"tiny-sender__input-wrapper",ref_key:"inputWrapperRef",ref:b},[U(De,{name:"tiny-sender-slide-down"},{default:pe(()=>[a.$slots.header?(m(),T("div",Ht,[re(a.$slots,"header",{},void 0,!0)])):q("",!0)]),_:3}),N("div",{class:ae(["tiny-sender__input-row",{"has-prefix":a.$slots.prefix,"has-header":a.$slots.header}])},[a.$slots.prefix?(m(),T("div",Jt,[re(a.$slots,"prefix",{},void 0,!0)])):q("",!0),N("div",Qt,[a.$slots.decorativeContent?(m(),T("div",Ut,[re(a.$slots,"decorativeContent",{},void 0,!0)])):q("",!0),L.value?(m(),Y(Ft,{key:1,ref_key:"templateEditorRef",ref:v,"model-value":p.templateData,"onUpdate:modelValue":Le,onSubmit:_(ie)},null,8,["model-value","onSubmit"])):(m(),T("div",Xt,[U(_(ft),{ref_key:"inputRef",ref:l,autosize:a.autoSize,type:Ie.value,resize:"none",modelValue:_(w),"onUpdate:modelValue":C[0]||(C[0]=M=>lt(w)?w.value=M:null),disabled:r.value,placeholder:a.placeholder,autofocus:a.autofocus,onKeydown:_(Oe),onCompositionstart:C[1]||(C[1]=M=>F.value=!0),onCompositionend:I,onFocus:Ke,onBlur:Me},null,8,["autosize","type","modelValue","disabled","placeholder","autofocus","onKeydown"]),_(K)&&!_(F)?(m(),T("div",Yt,[N("span",Zt,ue(_(w)),1),Je(ue(_(K))+" ",1),_(Z)?(m(),T("div",en,"TAB")):q("",!0)])):q("",!0)]))]),A.value==="single"?(m(),T("div",tn,[N("div",{class:"tiny-sender__buttons-container",ref_key:"buttonsContainerRef",ref:B},[re(a.$slots,"actions",{},void 0,!0),U(Qe,{"allow-speech":a.allowSpeech,"allow-files":a.allowFiles,loading:a.loading,disabled:r.value,"show-clear":a.clearable,"has-content":W.value,"speech-status":_(oe),"button-group":a.buttonGroup,"submit-type":a.submitType,"is-over-limit":ce.value,"stop-text":a.stopText,onClear:he,onToggleSpeech:se,onSubmit:_(ie),onCancel:C[2]||(C[2]=M=>a.$emit("cancel")),onTriggerSelect:_(V)},null,8,["allow-speech","allow-files","loading","disabled","show-clear","has-content","speech-status","button-group","submit-type","is-over-limit","stop-text","onSubmit","onTriggerSelect"])],512)])):q("",!0)],2),U(De,{name:"tiny-sender-slide-up"},{default:pe(()=>[A.value==="multiple"?(m(),T("div",{key:0,style:We(e.value),class:"tiny-sender__footer-slot tiny-sender__bottom-row"},[N("div",nn,[re(a.$slots,"footer-left",{},void 0,!0)]),N("div",an,[re(a.$slots,"footer-right",{},void 0,!0),a.showWordLimit&&a.maxLength!==1/0?(m(),T("div",{key:0,class:ae(["tiny-sender__word-limit",{"is-over-limit":ce.value}])},[N("span",ln,ue(_(w).length),1),Je("/"+ue(a.maxLength),1)],2)):q("",!0),A.value==="multiple"?(m(),T("div",on,[N("div",sn,[U(Qe,{"allow-speech":a.allowSpeech,"allow-files":a.allowFiles,loading:a.loading,disabled:r.value,"show-clear":a.clearable,"has-content":W.value,"speech-status":_(oe),"button-group":a.buttonGroup,"submit-type":a.submitType,"is-over-limit":ce.value,"stop-text":a.stopText,onClear:he,onToggleSpeech:se,onSubmit:_(ie),onCancel:C[3]||(C[3]=M=>a.$emit("cancel")),onTriggerSelect:_(V)},null,8,["allow-speech","allow-files","loading","disabled","show-clear","has-content","speech-status","button-group","submit-type","is-over-limit","stop-text","onSubmit","onTriggerSelect"])])])):q("",!0)])],4)):a.$slots.footer?(m(),T("div",rn,[re(a.$slots,"footer",{},void 0,!0)])):q("",!0)]),_:3})],512)]),U(Pt,{show:_(h),suggestions:a.suggestions,"popup-style":S.value,"active-keyboard-index":_(k),"active-mouse-index":_(X),"input-value":_(w),onSelect:_(x),onMouseEnter:_(de),onMouseLeave:_(Se)},null,8,["show","suggestions","popup-style","active-keyboard-index","active-mouse-index","input-value","onSelect","onMouseEnter","onMouseLeave"])],10,Nt))}}),Ee=_e(un,[["__scopeId","data-v-520fdb31"]]);Ee.name="TrSender";const dn=function(i){i.component(Ee.name,Ee)};Ee.install=dn;export{Ee as L};
