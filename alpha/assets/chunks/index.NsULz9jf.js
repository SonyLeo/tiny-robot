import{an as S,q as O,p as B,as as w}from"./framework.CdlzW3Za.js";var b=class{constructor(e){this.config=e}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}validateRequest(e){if(!e.messages||!Array.isArray(e.messages)||e.messages.length===0)throw new Error("请求必须包含至少一条消息");for(let i of e.messages)if(!i.role||!i.content)throw new Error("每条消息必须包含角色和内容")}},_=(e=>(e.NETWORK_ERROR="network_error",e.AUTHENTICATION_ERROR="authentication_error",e.RATE_LIMIT_ERROR="rate_limit_error",e.SERVER_ERROR="server_error",e.MODEL_ERROR="model_error",e.TIMEOUT_ERROR="timeout_error",e.UNKNOWN_ERROR="unknown_error",e))(_||{}),T=(e=>(e.DATA="data",e.ERROR="error",e.DONE="done",e))(T||{});function y(e){return{type:e.type||"unknown_error",message:e.message||"未知错误",statusCode:e.statusCode,originalError:e.originalError}}function R(e){var i;if(!e.response)return y({type:"network_error",message:"网络连接错误，请检查您的网络连接",originalError:e});if(e.response){let{status:t,data:c}=e.response;return t===401||t===403?y({type:"authentication_error",message:"身份验证失败，请检查您的API密钥",statusCode:t,originalError:e}):t===429?y({type:"rate_limit_error",message:"超出API调用限制，请稍后再试",statusCode:t,originalError:e}):t>=500?y({type:"server_error",message:"服务器错误，请稍后再试",statusCode:t,originalError:e}):y({type:"unknown_error",message:((i=c==null?void 0:c.error)==null?void 0:i.message)||`请求失败，状态码: ${t}`,statusCode:t,originalError:e})}return e.code==="ECONNABORTED"?y({type:"timeout_error",message:"请求超时，请稍后再试",originalError:e}):y({type:"unknown_error",message:e.message||"发生未知错误",originalError:e})}async function N(e,i,t){var g,d,v;let c=(g=e.body)==null?void 0:g.getReader();if(!c)throw new Error("Response body is null");let p=new TextDecoder,n="",f,r;t&&t.addEventListener("abort",()=>{c.cancel().catch(D=>console.error("Error cancelling reader:",D))},{once:!0});try{for(;;){if(t!=null&&t.aborted){await c.cancel();break}let{done:D,value:F}=await c.read();if(D)break;let C=p.decode(F,{stream:!0});n+=C;let m=n.split(`

`);n=m.pop()||"";for(let a of m)if(a.trim()!==""){if(a.trim()==="data: [DONE]"){r&&(f=r),i.onDone(f);continue}try{let l=a.match(/^data: (.+)$/m);if(!l)continue;let h=JSON.parse(l[1]);i.onData(h),r=((v=(d=h.choices)==null?void 0:d[0])==null?void 0:v.finish_reason)||void 0}catch(l){console.error("Error parsing SSE message:",l)}}}(n.trim()==="data: [DONE]"||t!=null&&t.aborted)&&(t!=null&&t.aborted&&(f="aborted"),i.onDone(f))}catch(D){if(t!=null&&t.aborted)return;throw D}}var M=class extends b{constructor(e){super(e),this.defaultModel="gpt-3.5-turbo",this.baseURL=e.apiUrl||"https://api.openai.com/v1",this.apiKey=e.apiKey||"",e.defaultModel&&(this.defaultModel=e.defaultModel),this.apiKey||console.warn("API key is not provided. Authentication will likely fail.")}async chat(e){var i;try{this.validateRequest(e);let t={model:((i=e.options)==null?void 0:i.model)||this.config.defaultModel||this.defaultModel,messages:e.messages,...e.options,stream:!1},c={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)};this.apiKey&&Object.assign(c.headers,{Authorization:`Bearer ${this.apiKey}`});let p=await fetch(`${this.baseURL}/chat/completions`,c);if(!p.ok){let n=await p.text();throw new Error(`HTTP error! status: ${p.status}, details: ${n}`)}return await p.json()}catch(t){throw R(t)}}async chatStream(e,i){var p;let{signal:t,...c}=e.options||{};try{this.validateRequest(e);let n={model:((p=e.options)==null?void 0:p.model)||this.config.defaultModel||this.defaultModel,messages:e.messages,...c,stream:!0},f={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,Accept:"text/event-stream"},body:JSON.stringify(n),signal:t};this.apiKey&&Object.assign(f.headers,{Authorization:`Bearer ${this.apiKey}`});let r=await fetch(`${this.baseURL}/chat/completions`,f);if(!r.ok){let g=await r.text();throw new Error(`HTTP error! status: ${r.status}, details: ${g}`)}await N(r,i,t)}catch(n){if(t!=null&&t.aborted)return;i.onError(R(n))}}updateConfig(e){super.updateConfig(e),e.apiUrl&&(this.baseURL=e.apiUrl),e.apiKey&&(this.apiKey=e.apiKey),e.defaultModel&&(this.defaultModel=e.defaultModel)}},x=class{constructor(e){this.config=e,this.provider=this.createProvider(e)}createProvider(e){if(e.provider==="custom"&&"providerImplementation"in e)return e.providerImplementation;switch(e.provider){case"deepseek":let i={defaultModel:"deepseek-chat",apiUrl:"https://api.deepseek.com/v1"};return new M({...i,...e});case"openai":default:return new M(e)}}async chat(e){return this.provider.chat(e)}async chatStream(e,i){let t={...e,options:{...e.options,stream:!0}};return this.provider.chatStream(t,i)}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e},e.provider&&e.provider!==this.config.provider?this.provider=this.createProvider(this.config):this.provider.updateConfig(this.config)}},k=(e=>(e.INIT="init",e.PROCESSING="processing",e.STREAMING="streaming",e.FINISHED="finished",e.ABORTED="aborted",e.ERROR="error",e))(k||{}),I=["processing","streaming"];function K(e){let{client:i,useStreamByDefault:t=!0,errorMessage:c="请求失败，请稍后重试",initialMessages:p=[]}=e,n=B([...p]),f=B(""),r=B(t),g=null,d=S({status:"init",errorMsg:null}),v=a=>{var s;let l=(s=e.events)==null?void 0:s.onReceiveData,h=!1;if(l&&l(a,n,()=>{h=!0}),!h){let u={role:"assistant",content:a.choices[0].message.content};n.value.push(u)}},D=async a=>{let l=await i.chat({messages:w(n.value),options:{stream:!1,signal:a.signal}});v(l)},F=a=>{var s,u;let l=(s=e.events)==null?void 0:s.onReceiveData,h=!1;if(l&&l(a,n,()=>{h=!0}),!h){n.value[n.value.length-1].role==="user"&&n.value.push({role:"assistant",content:""});let o=(u=a.choices)==null?void 0:u[0];o&&o.delta.content&&(n.value[n.value.length-1].content+=o.delta.content)}},C=async a=>{await i.chatStream({messages:w(n.value),options:{stream:!0,signal:a.signal}},{onData:l=>{d.status="streaming",F(l)},onError:l=>{d.status="error",d.errorMsg=c,console.error("Stream request error:",l)},onDone:l=>{var u;let h=(u=e.events)==null?void 0:u.onFinish,s=!1;if(h&&h(l,{messages:n,messageState:d},()=>{s=!0}),!s){if(l==="aborted"||d.status==="aborted")return;d.status="finished"}}})},m=async()=>{d.status="processing",d.errorMsg=null,g=new AbortController;try{r.value?await C(g):await D(g)}catch(a){d.errorMsg=c,d.status="error",console.error("Send message error:",a)}finally{g=null}};return{messages:n,messageState:d,inputMessage:f,useStream:r,sendMessage:async(a=f.value,l=!0)=>{if(I.includes(d.status)||!a||typeof a=="string"&&!a.trim()||Array.isArray(a)&&a.length===0)return;let h={role:"user",content:a};n.value.push(h),l&&(f.value=""),await m()},send:async()=>{I.includes(d.status)||await m()},clearMessages:()=>{n.value=[],d.errorMsg=null},addMessage:a=>{Array.isArray(a)?n.value.push(...a):n.value.push(a)},abortRequest:()=>{g&&(g.abort(),g=null,d.status="aborted")},retryRequest:async a=>{a===0||!n.value[a]||n.value[a].role==="user"||(n.value.splice(a),await m())}}}var P=class{constructor(e="tiny-robot-ai-conversations"){this.storageKey=e}saveConversations(e){try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(i){console.error("保存会话失败:",i)}}loadConversations(){try{let e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch(e){return console.error("加载会话失败:",e),[]}}};function U(){return Date.now().toString(36)+Math.random().toString(36).substring(2,9)}function L(e){let{client:i,storage:t=new P,autoSave:c=!0,allowEmpty:p=!1,useStreamByDefault:n=!0,errorMessage:f="请求失败，请稍后重试"}=e,r=S({conversations:[],currentId:null,loading:!1}),g=K({client:i,useStreamByDefault:n,errorMessage:f,initialMessages:[],events:e.events});O(()=>g.messages.value,s=>{if(r.currentId&&s.length>0){let u=r.conversations.findIndex(o=>o.id===r.currentId);u!==-1&&(r.conversations[u].messages=[...s],r.conversations[u].updatedAt=Date.now(),c&&m())}},{deep:!0});let d=(s="新会话",u={})=>{if(!p&&g.messages.value.length===0&&r.currentId)return r.currentId;let o=U(),E={id:o,title:s,createdAt:Date.now(),updatedAt:Date.now(),messages:[],metadata:u};return r.conversations.unshift(E),v(o),c&&m(),o},v=s=>{let u=r.conversations.find(o=>o.id===s);u&&(r.currentId=s,g.clearMessages(),u.messages.length>0&&u.messages.forEach(o=>g.addMessage(o)))},D=s=>{let u=r.conversations.findIndex(o=>o.id===s);u!==-1&&(r.conversations.splice(u,1),r.currentId===s&&(r.conversations.length>0?v(r.conversations[0].id):(r.currentId=null,g.clearMessages())),c&&m())},F=(s,u)=>{let o=r.conversations.find(E=>E.id===s);o&&(o.title=u,o.updatedAt=Date.now(),c&&m())},C=(s,u)=>{let o=r.conversations.find(E=>E.id===s);o&&(o.metadata={...o.metadata,...u},o.updatedAt=Date.now(),c&&m())},m=async()=>{try{await t.saveConversations(r.conversations)}catch(s){console.error("保存会话失败:",s)}},a=async()=>{r.loading=!0;try{let s=await t.loadConversations();r.conversations=s,s.length>0&&!r.currentId&&v(s[0].id)}catch(s){console.error("加载会话失败:",s)}finally{r.loading=!1}},l=async s=>{let u=r.conversations.find(o=>o.id===s);if(!u||u.messages.length<2)return(u==null?void 0:u.title)||"新会话";try{let o={role:"system",content:"请根据以下对话内容，生成一个简短的标题（不超过20个字符）。只需要返回标题文本，不需要任何解释或额外内容。"},E=u.messages.slice(0,Math.min(4,u.messages.length)),A=(await i.chat({messages:[o,...E],options:{stream:!1,max_tokens:30}})).choices[0].message.content.trim();return F(s,A),A}catch(o){return console.error("生成标题失败:",o),u.title}},h=()=>r.currentId&&r.conversations.find(s=>s.id===r.currentId)||null;return a(),{state:r,messageManager:g,createConversation:d,switchConversation:v,deleteConversation:D,updateTitle:F,updateMetadata:C,saveConversations:m,loadConversations:a,generateTitle:l,getCurrentConversation:h}}export{I as N,x as O,K as _,L as i,k as j};
