import{d as _e,p as A,h as K,q as te,a1 as nt,c as T,o as m,j as z,G as U,w as ce,e as W,r as ie,T as Fe,n as ne,b as Z,k as S,ax as at,a as He,t as re,P as ee,aQ as ot,aB as lt,aC as st,v as it,x as rt,F as pe,B as we,K as me,N as Je,a0 as ut,aO as dt,C as ct}from"./framework.DrGfhPAt.js";import{I as pt}from"./index.DEUmgi2i.js";import{T as Ve}from"./index.DEgDKdua.js";import{K as ft}from"./index2.eHSojToQ.js";import{p as vt,I as yt,u as gt,x as ht,l as mt,i as wt,z as _t}from"./tiny-robot-svgs.BbDZZ-ON.js";import{s as be}from"./plugin-vue_export-helper.lGy7RumW.js";import{e as bt}from"./utils.BIHqGXjM.js";function xt(i,r){const l=A(i.modelValue||i.defaultValue||""),g=A(null);te(()=>i.modelValue,v=>{v!==void 0&&v!==l.value&&(l.value=v)}),te(()=>l.value,v=>{r("update:modelValue",v)});const p=v=>{l.value=v,r("update:modelValue",v)},y=v=>{v==null||v.preventDefault();const b=l.value;!i.disabled&&!i.loading&&b.trim()&&r("submit",b)},o=()=>{l.value="",r("update:modelValue",""),r("clear")},c=A(!1);return{inputValue:l,inputWrapper:g,isComposing:c,handleChange:p,handleSubmit:y,handleClear:o,clearInput:()=>{o()}}}function St(i,r,l,g,p,y,o,c,v,b,B,L,_,F,G,q){const I=()=>{L.value&&(G!=null&&G.value&&(q==null||q()),r("submit",l.value.trim()))},h=(f,k)=>{if(f.key!=="Enter")return!1;switch(k){case"enter":return!f.shiftKey&&!f.ctrlKey&&!f.metaKey;case"ctrlEnter":return(f.ctrlKey||f.metaKey)&&!f.shiftKey;case"shiftEnter":return f.shiftKey&&!f.ctrlKey&&!f.metaKey;default:return!1}};return{handleKeyPress:f=>{if(!g.value){if(f.key==="Enter"&&f.shiftKey&&(_==null?void 0:_.value)==="single"&&F){f.preventDefault(),F();const k=f.target,Y=k.selectionStart,$=l.value;l.value=$.substring(0,Y)+`
`+$.substring(Y),setTimeout(()=>{k.selectionStart=k.selectionEnd=Y+1},0);return}if(f.key==="Tab"&&y.value&&o.value){f.preventDefault(),c();return}if(y.value){if(f.key==="ArrowDown"){f.preventDefault(),b("down");return}if(f.key==="ArrowUp"){f.preventDefault(),b("up");return}if(f.key==="Enter"&&o.value){f.preventDefault(),c();return}}if(f.key==="Escape"){y.value?(v(),f.preventDefault()):p.isRecording&&(B(),f.preventDefault()),r("escape-press");return}h(f,i.submitType)&&(f.preventDefault(),L.value&&I())}},triggerSubmit:I}}function Ct(i){const r=ot({isRecording:!1,isSupported:typeof window<"u"&&"webkitSpeechRecognition"in window||"SpeechRecognition"in window,error:void 0}),l=r.isSupported?new(window.webkitSpeechRecognition||window.SpeechRecognition):void 0;l!==void 0&&(l.continuous=i.continuous??!1,l.interimResults=i.interimResults??!0,l.lang=i.lang??navigator.language,l.onstart=()=>{var o;r.isRecording=!0,r.error=void 0,(o=i.onStart)==null||o.call(i)},l.onend=()=>{var o;r.isRecording=!1,(o=i.onEnd)==null||o.call(i)},l.onresult=o=>{var c,v;const b=Array.from(o.results).map(B=>B[0].transcript).join("");o.results[0].isFinal?(c=i.onFinal)==null||c.call(i,b):(v=i.onInterim)==null||v.call(i,b)},l.onerror=o=>{var c;r.error=new Error(o.error),r.isRecording=!1,(c=i.onError)==null||c.call(i,r.error)});const g=()=>{var o;if(!l){const c=new Error("浏览器不支持语音识别");r.error=c,(o=i.onError)==null||o.call(i,c);return}if(r.isRecording){try{l.stop(),setTimeout(()=>{try{l.start()}catch(c){y(c)}},100)}catch(c){y(c)}return}try{l.start()}catch(c){y(c)}},p=()=>{if(l&&r.isRecording)try{l.stop()}catch(o){y(o)}},y=o=>{var c;r.error=o instanceof Error?o:new Error("语音识别操作失败"),r.isRecording=!1,(c=i.onError)==null||c.call(i,r.error)};return{speechState:r,start:g,stop:p}}function kt(i,r,l,g,p,y){const o=A(!1),c=A(-1),v=A(-1),b=A(null),B=A(""),L=A(!1),_=K(()=>{var x,H;if(!((x=i.value)!=null&&x.length))return"";const J=b.value==="mouse"?v.value:c.value;return((H=i.value[J])==null?void 0:H.content)||""}),F=x=>{B.value=x,L.value=!0},G=()=>{B.value="",L.value=!1},q=x=>{const H=x||_.value;if(!H||!r.value){G();return}const J=H.substring(r.value.length);H.toLowerCase().startsWith(r.value.toLowerCase())&&J?F(J):G()},I=()=>{c.value=-1,v.value=-1,b.value=null},h=()=>{o.value=!0,q()},f=()=>{o.value=!1,I(),G()},k=K(()=>{var x;return l.value?!0:!!(r.value&&((x=i.value)==null?void 0:x.length)>0&&!g.value)}),Y=x=>{f(),r.value=x,p(x),y(x)},$=()=>{_.value&&Y(_.value)},Q=x=>{!o.value||!i.value||(b.value="keyboard",c.value===-1?c.value=x==="down"?0:i.value.length-1:x==="down"?c.value=(c.value+1)%i.value.length:c.value=(c.value-1+i.value.length)%i.value.length,q())},fe=x=>{i.value&&(b.value="mouse",v.value=x,q())},N=()=>{i.value&&(v.value=-1,c.value!==-1?b.value="keyboard":b.value=null,q())};return te(k,x=>{x?o.value||h():o.value&&f()}),{isPopupVisible:o,openPopup:h,closePopup:f,autoCompleteText:B,showTabIndicator:L,syncAutoComplete:q,activeSuggestion:_,activeKeyboardIndex:c,activeMouseIndex:v,navigateWithKeyboard:Q,handleMouseEnter:fe,handleMouseLeave:N,applySuggestion:Y,confirmSelection:$}}const Tt={class:"action-buttons"},Rt={class:"action-buttons__submit-content"},It={key:0,class:"action-buttons__cancel-text"},Ot=_e({__name:"ActionButtons",props:{loading:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},showClear:{type:Boolean,default:!0},hasContent:{type:Boolean,default:!1},buttonGroup:{},allowSpeech:{type:Boolean,default:!1},speechStatus:{default:()=>({isRecording:!1,isSupported:!1})},allowFiles:{type:Boolean,default:!1},submitType:{default:"enter"},showShortcuts:{type:Boolean},isOverLimit:{type:Boolean,default:!1},stopText:{default:void 0}},emits:["clear","toggle-speech","submit","cancel","trigger-select"],setup(i,{emit:r}){const l=i,g=r,p=K(()=>{var h,f;const k=(f=(h=l.buttonGroup)==null?void 0:h.file)==null?void 0:f.tooltips;if(typeof k=="string"&&k)return()=>k;if(typeof k=="function")return k}),y=K(()=>{var h,f;const k=(f=(h=l.buttonGroup)==null?void 0:h.submit)==null?void 0:f.tooltips;if(typeof k=="string"&&k)return()=>k;if(typeof k=="function")return k}),o=K(()=>l.allowSpeech),c=K(()=>l.speechStatus.isRecording),v=K(()=>l.disabled),b=K(()=>{var h,f;return v.value||l.isOverLimit||((f=(h=l.buttonGroup)==null?void 0:h.submit)==null?void 0:f.disabled)}),B=K(()=>l.allowFiles||l.allowSpeech||l.showClear),L=()=>{v.value||g("clear")},_=()=>{if(!v.value){const h=!l.speechStatus.isRecording;g("toggle-speech",h)}},F=()=>{b.value||g("submit")},G=()=>{v.value||g("cancel")},q=K(()=>{var h,f;return v.value||((f=(h=l.buttonGroup)==null?void 0:h.file)==null?void 0:f.disabled)}),I=()=>{q.value||g("trigger-select")};return(h,f)=>(m(),T("div",Tt,[B.value?(m(),T("div",{key:0,class:"action-buttons__utility",style:Je({"padding-right":h.hasContent||h.loading?"0":"6px"})},[h.allowFiles&&!h.loading?(m(),Z(S(Ve),{key:0,effect:"light",placement:"top","render-content":p.value,"visible-arrow":!1},{default:ce(()=>[z("div",{class:"action-buttons__button",onClick:I},[U(S(vt),{class:ne(["action-buttons__icon","action-buttons__icon--upload",{"is-disabled":q.value}]),alt:"上传文件"},null,8,["class"])])]),_:1},8,["render-content"])):W("",!0),o.value&&!h.loading?(m(),T("div",{key:1,class:ne(["action-buttons__button",{"is-recording":c.value}]),onClick:_},[c.value?(m(),Z(S(yt),{key:1,class:"action-buttons__icon action-buttons__icon--recording",alt:"语音中"})):(m(),Z(S(gt),{key:0,class:"action-buttons__icon",alt:"录音"}))],2)):W("",!0),h.showClear?(m(),Z(S(Ve),{key:2,content:"清空内容",placement:"top"},{default:ce(()=>[z("div",{class:"action-buttons__button",onClick:L},[U(S(ht),{class:"action-buttons__icon action-buttons__icon--clear"})])]),_:1})):W("",!0)],4)):W("",!0),h.hasContent||h.loading?(m(),T("div",{key:1,class:"action-buttons__button action-buttons__submit",onClick:f[0]||(f[0]=k=>h.loading?G():F())},[z("div",Rt,[h.loading?(m(),T("div",{key:1,class:ne(["action-buttons__cancel",{"action-buttons__cancel--icon-only":!h.stopText}])},[U(S(mt),{class:"action-buttons__icon action-buttons__icon--cancel",alt:"停止"}),h.stopText?(m(),T("span",It,re(h.stopText),1)):W("",!0)],2)):(m(),Z(S(Ve),{key:0,effect:"light",placement:"top","render-content":y.value,"visible-arrow":!1},{default:ce(()=>[U(S(wt),{class:ne(["action-buttons__icon","action-buttons__icon--send",{"is-disabled":b.value}]),alt:"发送"},null,8,["class"])]),_:1},8,["render-content"]))])])):W("",!0)]))}}),je=be(Ot,[["__scopeId","data-v-ee42294d"]]);function Et(i,r={}){let l=[],g=[],p=i;return{commit:y=>{var o;l.push(p),p=y,g.length&&((o=r.onRemoveHistory)==null||o.call(r,g)),g=[]},undo:()=>l.length?(g.push(p),p=l.pop(),p):null,redo:()=>g.length?(l.push(p),p=g.pop(),p):null,clear:()=>{var y,o;l.length&&((y=r.onRemoveHistory)==null||y.call(r,l)),g.length&&((o=r.onRemoveHistory)==null||o.call(r,g)),l=[],g=[]},get:()=>p}}const Bt=["data-id","data-type"],Lt=["data-id","data-type"],$t=_e({inheritAttrs:!1,__name:"Block",props:{id:{},type:{},content:{},readonly:{type:Boolean},asChild:{type:Boolean}},setup(i){const r=i,l=dt();return(g,p)=>{const y=ct("Block",!0);return r.type!=="block"?(m(),T("span",me({key:0,"data-id":r.id,"data-type":r.type},S(l)),re(r.content),17,Bt)):(m(),T(pe,{key:1},[r.asChild?(m(!0),T(pe,{key:0},we(r.content,o=>(m(),Z(y,me({key:`${o.id}-${o.type}`},{ref_for:!0},o),null,16))),128)):(m(),T("span",me({key:1,"data-id":r.id,"data-type":r.type},S(l)),[(m(!0),T(pe,null,we(r.content,o=>(m(),Z(y,me({key:`${o.id}-${o.type}`},{ref_for:!0},o),null,16))),128))],16,Lt))],64))}}}),Mt=be($t,[["__scopeId","data-v-13862606"]]),Kt={class:"editor-container"},De="​",Vt=_e({__name:"TemplateEditor",props:{modelValue:{default:()=>[]},modelModifiers:{}},emits:lt(["submit"],["update:modelValue"]),setup(i,{expose:r,emit:l}){const g=typeof window.ShadowRoot.prototype.getSelection=="function",p=typeof window.Selection.prototype.getComposedRanges=="function";function y(){const e=navigator.userAgent;return e.includes("Safari")&&!e.includes("Chrome")&&!e.includes("Chromium")&&!e.includes("CriOS")}const o=y(),c=()=>Math.random().toString(36).substring(2,15),v=De,b=De,B=De,L=st(i,"modelValue"),_=l,F=A(0),G=e=>e.map(n=>({id:n.id||c(),...n.type==="template"?{...n,prefix:b,suffix:B}:n})),q=e=>e.map(n=>({id:n.id,type:n.type,content:n.content})),I=A(G(L.value||[])),h=e=>{I.value=e},f=K(()=>{const e=[],n=[],t=I.value;if(t.length>=2){const s=t[0],d=t[1];s.type==="text"&&s.content.length===0&&d.type==="template"&&e.push({...s,content:v});const C=t[t.length-1],R=t[t.length-2];C.type==="text"&&C.content.length===0&&R.type==="template"&&n.push({...C,content:v})}t.length>0&&t[0].type==="template"&&e.push({type:"text",content:v,id:c()}),t.length>0&&t[t.length-1].type==="template"&&n.push({type:"text",content:v,id:c()});const u=new RegExp(v,"g");return t.length>0&&(t[0].content!==v&&(t[0].content=t[0].content.replace(u,"")),t[t.length-1].content!==v&&(t[t.length-1].content=t[t.length-1].content.replace(u,""))),e.concat(t).concat(n)}),k=K(()=>I.value.map(e=>e.type==="template"?[{id:e.id,type:"prefix",content:e.prefix},{id:e.id,type:"template",content:e.content},{id:e.id,type:"suffix",content:e.suffix}]:[e]).flat()),Y=K(()=>f.value.map(e=>e.type==="text"?e:o?{id:e.id,type:"block",asChild:!0,content:[{id:e.id,type:"prefix",content:e.prefix},{id:e.id,type:"block",content:[{id:e.id,type:"template",content:e.content},{id:e.id,type:"suffix",content:e.suffix}]}]}:{id:e.id,type:"block",asChild:!0,content:[{id:e.id,type:"block",content:[{id:e.id,type:"prefix",content:e.prefix},{id:e.id,type:"template",content:e.content}]},{id:e.id,type:"suffix",content:e.suffix}]})),$=A(null),Q=e=>{const n=Date.now(),t=JSON.stringify(e);return`${n}:${t}`},fe=e=>{const n=parseInt(e.slice(0,13)),t=JSON.parse(e.slice(14));return{timestamp:n,data:t}},N=new Map,x=Et(Q(I.value),{onRemoveHistory:e=>{for(const n of e)N.delete(n)}});te(()=>L.value,e=>{const n=G(e||[]);if(JSON.stringify(n)!==JSON.stringify(I.value)){if($.value){const t=ue($.value);t&&N.set(x.get(),j(t))}h(n),x.commit(Q(I.value))}},{deep:!0});const H=(e,n=document.body)=>n.contains(e)?e instanceof HTMLElement&&e.dataset.id?e:e.parentElement?H(e.parentElement,n):null:null,J=e=>e===$.value,ue=e=>{const n=window.getSelection();if(!n)return null;const t=n.rangeCount>0?n.getRangeAt(0):null,u=e.getRootNode();if(!(u instanceof ShadowRoot))return t;if(p){const s=n.getComposedRanges(o?u:{shadowRoots:[u]});return(s==null?void 0:s[0])??null}if(g){const s=u.getSelection();return s.rangeCount>0?s.getRangeAt(0):null}return t},xe=(e,n)=>{var t;if(!e.firstChild||e.firstChild.nodeType!==Node.TEXT_NODE)return{node:e,offset:0};const u=((t=e.firstChild.textContent)==null?void 0:t.length)??0;return{node:e.firstChild,offset:Math.min(n,u)}},D=(e,n,t,u)=>{const s=window.getSelection();if(!s)return;const{node:d,offset:C}=xe(e,n);if(!t){s.setBaseAndExtent(d,C,d,C);return}const{node:R,offset:P}=xe(t,u??0);s.setBaseAndExtent(d,C,R,P)},X=(e,n)=>{const t=c(),u={id:t,type:"text",content:e};if(n){const s=I.value.findIndex(d=>d.id===n);s!==-1?(h(I.value.slice(0,s+1).concat(u).concat(I.value.slice(s+1))),x.commit(Q(I.value))):console.warn(`can not find item with id: ${n}`)}else h([u].concat(I.value)),x.commit(Q(I.value));ee(()=>{var s;const d=(s=$.value)==null?void 0:s.querySelector(`[data-id="${t}"][data-type="text"]`);d&&D(d,e.length)}),L.value=q(I.value)},ae=A({hasStarted:!1,range:null}),Be=e=>{var n;const t=e;e.preventDefault();const{inputType:u}=t,s=(t.data||((n=t.dataTransfer)==null?void 0:n.getData("text/plain"))||"").replace(b,"").replace(B,""),d=t.getTargetRanges()[0];if(!d){console.warn("range is null",d);return}const C=["insertText","insertFromPaste","insertReplacementText","deleteContentBackward","deleteContentForward","deleteWordBackward","deleteWordForward","deleteSoftLineBackward","deleteSoftLineForward","deleteByCut"],R=ue($.value);if(C.includes(u)){if(s&&J(d.startContainer)&&J(d.endContainer)){R&&N.set(x.get(),j(R)),X(s);return}const P=j(d);P.startId&&P.endId?(R&&N.set(x.get(),j(R)),Se(P,u,s)):console.warn("range is not valid, range:",P)}else u==="insertCompositionText"&&ae.value.hasStarted&&(ae.value={hasStarted:!1,range:j(d)})},j=e=>{const n=H(e.startContainer,$.value),t=H(e.endContainer,$.value);return{collapsed:e.collapsed,endContainer:e.endContainer,endId:t==null?void 0:t.dataset.id,endEl:t,endOffset:e.endOffset,endType:t==null?void 0:t.dataset.type,startContainer:e.startContainer,startId:n==null?void 0:n.dataset.id,startEl:n,startOffset:e.startOffset,startType:n==null?void 0:n.dataset.type}},ve=(e,n,t,u)=>e.slice(0,t)+n+e.slice(u),Se=(e,n,t)=>{const u=ge(e);if(!Array.isArray(u)||u.length===0)return;const s=Le(u,e,n,t);if(s.some(O=>O.tag==="new")){const{afterId:O,content:E}=s[0];X(E,O);return}const d=s,C=[];for(const[O,E]of d.entries()){const V=I.value.find(w=>w.id===E.id),a=O===0?t:"";V?V.type==="text"?V.content=ve(V.content,a,E.startOffset,E.endOffset):V.type==="template"?E.type==="prefix"||E.type==="suffix"?E.startOffset===0&&E.endOffset===1&&a.length===0?V[E.type]="":console.warn(`${E.type} can not be inserted text. it only can be deleted`,E):E.startOffset<0||E.endOffset>V.content.length?C.push(V.id):V.content=ve(V.content,a,E.startOffset,E.endOffset):console.warn("dataItem.type is not text or template",V):console.warn("can not find dataItem",E)}let R=I.value.filter(O=>!C.includes(O.id));R=R.filter(O=>!(O.type==="template"&&[O.prefix,O.suffix,O.content].join("").length===0));const P=new Set;R.forEach((O,E,V)=>{if(V.length>=2){if(E===0||E===1){const a=V[0],w=V[1];if(a.type==="text"&&a.content.length===0&&w.type==="template")return}if(E===V.length-2||E===V.length-1){const a=V[V.length-1],w=V[V.length-2];if(a.type==="text"&&a.content.length===0&&w.type==="template")return}}O.type==="text"&&O.content.length===0&&P.add(O.id)}),R=R.filter(O=>!P.has(O.id));for(const O of R.filter(E=>E.type==="template"))O.prefix.length===0&&(O.prefix=b),O.suffix.length===0&&(O.suffix=B);h(R),x.commit(Q(I.value)),d.length>0&&ye(d,t),L.value=q(I.value)},ye=(e,n)=>{const t=e[0],u=`[data-id="${t.id}"][data-type="${t.type}"]`,s=e.slice(1).map(d=>`[data-id="${d.id}"][data-type="${d.type}"]`);ee(()=>{var d,C;const R=(d=$.value)==null?void 0:d.querySelector(u);if(R)D(R,t.startOffset+n.length);else if(n.length===0)for(const P of s){const O=(C=$.value)==null?void 0:C.querySelector(P);if(O){D(O,0);break}}else console.warn(`can not find el with selector: ${u}`)})},ge=e=>{const n=k.value.findIndex(C=>C.id===e.startId&&C.type===e.startType),t=k.value.findIndex(C=>C.id===e.endId&&C.type===e.endType);if(n===-1||t===-1||n>t)return console.warn("startIndex or endIndex is -1, or startIndex > endIndex. ",{range:e}),null;const u=k.value[n],s=k.value[t];if(n===t)return[{id:u.id,type:u.type,startOffset:e.startOffset,endOffset:e.endOffset}];const d=[{id:u.id,type:u.type,startOffset:e.startOffset,endOffset:u.content.length}];for(let C=n+1;C<t;C++){const R=k.value[C];d.push({id:R.id,type:R.type,startOffset:0,endOffset:R.content.length})}return d.push({id:s.id,type:s.type,startOffset:0,endOffset:e.endOffset}),d},Le=(e,n,t,u)=>{const s=e[0];if(s.type!=="prefix"&&s.type!=="suffix")return e;if(e.length===1){if(n.collapsed)if(n.startOffset===0){const d=he(s,u);return d?[d]:[]}else{const d=oe(s,u);return d?[d]:[]}if(t.startsWith("insert"))if(o){const d=he(s,u);return d?[d]:[]}else{const d=oe(s,u);return d?[d]:[]}if(t.startsWith("delete")){if(t.includes("Backward")){const d=he(s,u,1);return d?[d]:[]}else if(t.includes("Forward")){const d=oe(s,u,1);return d?[d]:[]}}}return u.length>0?e.slice(1):e},he=(e,n,t=0)=>{const u=k.value.findIndex(s=>s.id===e.id&&s.type===e.type);if(u>0){const s=k.value[u-1],{id:d,type:C,content:R}=s;if(C==="text"||C==="template")return{id:d,type:C,startOffset:R.length-t,endOffset:R.length};if(n.length>0)return{tag:"new",afterId:d,type:"text",content:n};if(console.warn("the previous item is not text or template",{current:e,previous:s}),t===1)return{...e,endOffset:e.startOffset}}else return n.length>0?{tag:"new",type:"text",content:n}:(console.warn("the previous item of current is not found",{current:e}),null);return e},oe=(e,n,t=0)=>{const u=k.value.findIndex(s=>s.id===e.id&&s.type===e.type);if(u<k.value.length-1){const s=k.value[u+1],{id:d,type:C}=s;if(C==="text"||C==="template")return{id:d,type:C,startOffset:0,endOffset:0+t};if(n.length>0)return{tag:"new",afterId:e.id,type:"text",content:n};if(console.warn("the next item is not text or template",{current:e,next:s}),t===1)return{...e,startOffset:e.endOffset}}else return n.length>0?{tag:"new",afterId:e.id,type:"text",content:n}:(console.warn("the next item of current is not found",{current:e}),null);return e},Ce=()=>{ae.value={hasStarted:!0,range:null}},ke=e=>{const n=ae.value.range;n?(e.data&&J(n.startContainer)&&J(n.endContainer)?(N.set(x.get(),j(n)),X(e.data)):n.startId&&n.endId?(N.set(x.get(),j(n)),Se(n,"insertCompositionText",e.data)):console.warn("range is not valid, range:",n),F.value++):console.warn("range is null, compositionEnd:",e),ae.value={hasStarted:!1,range:null}},le=(()=>{const e=navigator.userAgent.toLowerCase();return/macintosh|mac os x|iphone|ipad|ipod/.test(e)})(),de=e=>{const n=le&&e.metaKey&&!e.shiftKey&&e.key.toLowerCase()==="z"||!le&&e.ctrlKey&&!e.shiftKey&&e.key.toLowerCase()==="z",t=le&&e.metaKey&&e.shiftKey&&e.key.toLowerCase()==="z"||!le&&e.ctrlKey&&(e.key.toLowerCase()==="y"||e.shiftKey&&e.key.toLowerCase()==="z"),u=e.key.toLowerCase()==="enter";if(n){e.preventDefault();const s=ue($.value);s&&N.set(x.get(),j(s));const d=x.undo();d&&Te(d)}if(t){e.preventDefault();const s=x.redo();s&&Te(s)}u&&(e.preventDefault(),_("submit"))},Te=e=>{const{data:n}=fe(e);if(h(n),N.has(e)){const t=N.get(e);ee(()=>{const u=$.value.querySelector(`[data-id="${t.startId}"][data-type="${t.startType}"]`),s=$.value.querySelector(`[data-id="${t.endId}"][data-type="${t.endType}"]`);u&&D(u,t.startOffset,s,t.endOffset)})}L.value=q(I.value)},se=(e,n)=>{var t,u;const s=(t=$.value)==null?void 0:t.querySelector(`[data-id="${e}"][data-type="${n}"]`);if(!s)return;const d=((u=s.textContent)==null?void 0:u.length)||0;D(s,d)},$e=()=>{$.value&&ee(()=>{const e=I.value,n=e.find(t=>t.type==="template");n&&se(n.id,"template"),e.every(t=>t.type==="text")&&e.length===1&&se(e[0].id,"text")})},Me=()=>{x.clear(),N.clear()},Re=()=>{if(!$.value||ae.value.range)return;const e=ue($.value);if(e!=null&&e.collapsed&&f.value.length>0){const n=j(e),t=f.value[0];if(n.startEl&&n.startId===t.id&&n.startOffset===0&&t.content===v&&t.type==="text"){D(n.startEl,1);return}const u=f.value[f.value.length-1];if(n.endEl&&n.endId===u.id&&n.endOffset===1&&u.content===v&&u.type==="text"){D(n.endEl,0);return}}};return it(()=>{document.addEventListener("selectionchange",Re)}),rt(()=>{document.removeEventListener("selectionchange",Re)}),r({clearHistory:Me,activateFirstField:$e}),(e,n)=>(m(),T("div",Kt,[(m(),T("div",{contenteditable:"true",ref_key:"editorRef",ref:$,key:F.value,class:"editor",onBeforeinput:Be,onCompositionstart:Ce,onCompositionend:ke,onKeydown:de},[(m(!0),T(pe,null,we(Y.value,t=>(m(),Z(Mt,me({key:`${t.id}-${t.type}`},{ref_for:!0},t),null,16))),128))],32))]))}}),Dt=be(Vt,[["__scopeId","data-v-5fda773e"]]),Ue=(i,r)=>{if(!r.length)return[{text:i,isMatch:!1}];const l=[];for(const o of r){if(!o)continue;let c=0;const v=i.toLowerCase(),b=o.toLowerCase();for(;;){const B=v.indexOf(b,c);if(B===-1)break;l.push({start:B,end:B+o.length}),c=B+1}}if(l.length===0)return[{text:i,isMatch:!1}];l.sort((o,c)=>o.start-c.start);const g=[];for(const o of l)if(g.length===0)g.push(o);else{const c=g[g.length-1];o.start<=c.end?c.end=Math.max(c.end,o.end):g.push(o)}const p=[];let y=0;for(const o of g)y<o.start&&p.push({text:i.substring(y,o.start),isMatch:!1}),p.push({text:i.substring(o.start,o.end),isMatch:!0}),y=o.end;return y<i.length&&p.push({text:i.substring(y),isMatch:!1}),p},Ft=(i,r)=>!r||!i?[{text:i,isMatch:!1}]:Ue(i,[r]),At=(i,r)=>{const{content:l,highlights:g}=i;return typeof g=="function"?g(l,r):Array.isArray(g)?Ue(l,g):Ft(l,r)},qt=["onMouseenter","onMousedown"],Wt={class:"suggestion-list__text"},Gt=_e({__name:"SuggestionList",props:{show:{type:Boolean},suggestions:{},popupStyle:{},activeKeyboardIndex:{},activeMouseIndex:{},inputValue:{}},emits:["select","mouse-enter","mouse-leave"],setup(i,{emit:r}){const l=i,g=r,p=A(null),y=b=>b===l.activeKeyboardIndex||b===l.activeMouseIndex,o=b=>{g("mouse-enter",b)},c=()=>{g("mouse-leave")},v=b=>{g("select",b)};return te(()=>l.activeKeyboardIndex,b=>{if(b!==-1&&p.value){const B=p.value.children[b];B&&B.scrollIntoView({block:"nearest"})}}),(b,B)=>(m(),Z(Fe,{name:"tiny-sender-slide-up"},{default:ce(()=>[l.show&&l.suggestions.length?(m(),T("div",{key:0,ref_key:"suggestionsListRef",ref:p,class:"suggestion-list",style:Je(l.popupStyle)},[(m(!0),T(pe,null,we(l.suggestions,(L,_)=>(m(),T("div",{key:_,class:ne(["suggestion-list__item",{highlighted:y(_)}]),onMouseenter:F=>o(_),onMouseleave:c,onMousedown:ut(F=>v(L.content),["prevent"])},[U(S(_t),{class:"suggestion-list__icon"}),z("span",Wt,[(m(!0),T(pe,null,we(S(At)(L,l.inputValue),(F,G)=>(m(),T("span",{key:G,class:ne({"suggestion-list__text--match":F.isMatch,"suggestion-list__text--normal":!F.isMatch})},re(F.text),3))),128))])],42,qt))),128))],4)):W("",!0)]),_:1}))}}),Nt=be(Gt,[["__scopeId","data-v-e0ec9fe3"]]),zt=["data-theme"],Pt={class:"tiny-sender__container"},Ht={key:0,class:"tiny-sender__header-slot"},jt={key:0,class:"tiny-sender__prefix-slot"},Jt={class:"tiny-sender__content-area"},Ut={key:0,class:"tiny-sender__decorative-content"},Yt={key:2,class:"tiny-sender__input-field-wrapper"},Zt={key:0,class:"tiny-sender__completion-placeholder"},Qt={class:"user-input-mirror"},Xt={key:0,class:"tiny-sender__tab-hint"},en={key:1,class:"tiny-sender__actions-slot"},tn={key:0,class:"tiny-sender__footer-slot tiny-sender__bottom-row"},nn={class:"tiny-sender__footer-left"},an={class:"tiny-sender__footer-right"},on={class:"real-word-length"},ln={key:1,class:"tiny-sender__toolbar"},sn={class:"tiny-sender__buttons-container"},rn={key:1,class:"tiny-sender__footer-slot"},un=_e({__name:"index",props:{autofocus:{type:Boolean,default:!1},autoSize:{type:[Boolean,Object],default:()=>({minRows:1,maxRows:3})},allowSpeech:{type:Boolean,default:!0},allowFiles:{type:Boolean,default:!1},clearable:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},defaultValue:{},loading:{type:Boolean,default:!1},modelValue:{default:""},mode:{default:"single"},maxLength:{default:1/0},buttonGroup:{},submitType:{default:"enter"},speech:{type:[Boolean,Object]},placeholder:{default:"请输入内容..."},showWordLimit:{type:Boolean,default:!1},suggestions:{default:()=>[]},suggestionPopupWidth:{default:400},theme:{default:"light"},templateData:{default:()=>[]},stopText:{default:""}},emits:["update:modelValue","update:templateData","submit","clear","speech-start","speech-end","speech-interim","speech-error","suggestion-select","focus","blur","escape-press","cancel","reset-template","files-selected"],setup(i,{expose:r,emit:l}){var g;const p=i,y=l,o=A(null),c=A(null),v=A(null),b=A(null),B=A(null),L=K(()=>p.templateData&&p.templateData.length>0),{inputValue:_,isComposing:F,clearInput:G}=xt(p,y),q=K(()=>!!_.value.trim()),I=K(()=>{var a,w;return!(p.disabled||p.loading||!q.value||de.value||(w=(a=p.buttonGroup)==null?void 0:a.submit)!=null&&w.disabled)}),{isPopupVisible:h,activeSuggestion:f,activeKeyboardIndex:k,activeMouseIndex:Y,autoCompleteText:$,showTabIndicator:Q,syncAutoComplete:fe,closePopup:N,applySuggestion:x,confirmSelection:H,navigateWithKeyboard:J,handleMouseEnter:ue,handleMouseLeave:xe}=kt(K(()=>p.suggestions),_,F,L,a=>y("update:modelValue",a),a=>y("suggestion-select",a)),D=A(p.mode),X=A(!1),ae=()=>{D.value==="single"&&(D.value="multiple",ee(()=>{setTimeout(()=>{const a=document.querySelector(".tiny-textarea__inner");if(a){a.style.whiteSpace="pre-wrap";const w=_.value.length;a.focus(),a.setSelectionRange(w,w)}},50)}))},Be=(a,w)=>{const M=document.createElement("span");M.style.visibility="hidden",M.style.position="absolute",M.style.whiteSpace="nowrap",M.style.font=w,M.textContent=a,document.body.appendChild(M);const Ie=M.offsetWidth;return document.body.removeChild(M),Ie},j=()=>{var a,w,M;if(p.mode!=="single"||!o.value||X.value||!c.value||!b.value)return;const Ie=c.value.querySelector(".tiny-sender__content-area");if(!Ie)return;const Ke=((w=(a=o.value)==null?void 0:a.querySelector)==null?void 0:w.call(a,".tiny-input__inner"))||Ie.querySelector(".tiny-input__inner"),Ae=B.value||c.value.querySelector(".tiny-sender__buttons-container");if(!Ke){console.warn("Cannot find input element for overflow check");return}const qe=Ke.getBoundingClientRect(),We=Ae==null?void 0:Ae.getBoundingClientRect();if(qe.width===0){setTimeout(()=>j(),50);return}const Ye=window.getComputedStyle(Ke).font,Ze=Be(_.value,Ye),Ge=(M=c.value)==null?void 0:M.classList.contains("tr-sender-compact"),Qe=Ge?12:20,Xe=qe.width,et=(We==null?void 0:We.width)||0,Ne=Xe-et-Qe,tt=Ge?50:80;Ze>Ne&&Ne>tt&&D.value==="single"&&(X.value=!0,D.value="multiple",ee(()=>{o.value?setTimeout(()=>{var ze;const Oe=(ze=c.value)==null?void 0:ze.querySelector(".tiny-textarea__inner");if(Oe){Oe.style.whiteSpace="pre-wrap";const Pe=_.value.length;Oe.focus(),Oe.setSelectionRange(Pe,Pe)}X.value=!1},300):X.value=!1}))},ve=()=>{if(L.value&&v.value)R();else if(o.value)o.value.focus();else{const a=document.querySelector(".tiny-input__inner");a==null||a.focus()}},Se=()=>{if(o.value)o.value.blur();else{const a=document.querySelector(".tiny-input__inner");a==null||a.blur()}},ye=()=>{var a;y("update:templateData",[]),(a=v.value)==null||a.clearHistory(),ee(()=>{_.value===""&&(D.value=p.mode||"single"),setTimeout(()=>{ve()},50)})},ge=()=>{var a;G(),L.value?ye():(a=c.value)==null||a.focus(),ee(()=>{_.value===""&&(D.value=p.mode||"single")})},Le=a=>{const w=M=>M.type==="text"&&M.content==="​";if(a.length===0||a.every(w)){ye();return}y("update:templateData",a)};te(()=>p.templateData,()=>{_.value=p.templateData.map(a=>a.content).join("")},{deep:!0});const he=K(()=>{const a=typeof p.speech=="object"?p.speech:{};return{...a,onStart:()=>y("speech-start"),onEnd:w=>y("speech-end",w),onInterim:w=>y("speech-interim",w),onFinal:w=>{if(a.autoReplace)_.value=w;else{const M=_.value;M&&w&&!M.endsWith(" ")&&!w.startsWith(" ")&&M.length>0?_.value=M+" "+w:_.value=M+w}y("speech-end",w)},onError:w=>{y("speech-error",w)}}}),{speechState:oe,start:Ce,stop:ke}=Ct(he.value),le=()=>{oe.isRecording?ke():Ce()},de=K(()=>p.maxLength!==1/0&&_.value.length>p.maxLength),{handleKeyPress:Te,triggerSubmit:se}=St(p,y,_,F,oe,h,f,H,N,J,le,I,D,ae,L,ye),$e=a=>{y("focus",a),_.value&&!L.value&&(h.value=!0)},Me=a=>{y("blur",a),N()},Re=K(()=>D.value==="multiple"?"textarea":"text"),e=nt(),n=K(()=>!!e.decorativeContent),t=K(()=>p.disabled||n.value),u=K(()=>p.loading),s=K(()=>({"is-disabled":t.value,"is-loading":u.value,"is-auto-switching":X.value})),d=K(()=>({width:bt(p.suggestionPopupWidth),maxWidth:"100%"})),C=()=>{F.value=!1};te(_,()=>{ee(j),_.value===""&&p.mode==="single"&&(D.value="single"),fe()}),te(()=>L.value,a=>{a&&(D.value="multiple")});const R=()=>{v.value&&v.value.activateFirstField()},{accept:P="*",multiple:O=!0}=((g=p.buttonGroup)==null?void 0:g.file)||{},{open:E,files:V}=ft({accept:P,multiple:O});return te(V,a=>{a&&a.length>0&&y("files-selected",Array.from(a))}),r({focus:ve,blur:Se,clear:ge,submit:se,startSpeech:Ce,stopSpeech:ke,activateTemplateFirstField:R}),(a,w)=>(m(),T("div",{ref_key:"senderRef",ref:c,class:ne(["tiny-sender",[s.value,`theme-${a.theme}`,`mode-${D.value}`]]),"data-theme":a.theme},[z("div",Pt,[z("div",{class:"tiny-sender__input-wrapper",ref_key:"inputWrapperRef",ref:b},[U(Fe,{name:"tiny-sender-slide-down"},{default:ce(()=>[a.$slots.header?(m(),T("div",Ht,[ie(a.$slots,"header",{},void 0,!0)])):W("",!0)]),_:3}),z("div",{class:ne(["tiny-sender__input-row",{"has-prefix":a.$slots.prefix,"has-header":a.$slots.header}])},[a.$slots.prefix?(m(),T("div",jt,[ie(a.$slots,"prefix",{},void 0,!0)])):W("",!0),z("div",Jt,[a.$slots.decorativeContent?(m(),T("div",Ut,[ie(a.$slots,"decorativeContent",{},void 0,!0)])):W("",!0),L.value?(m(),Z(Dt,{key:1,ref_key:"templateEditorRef",ref:v,"model-value":p.templateData,"onUpdate:modelValue":Le,onSubmit:S(se)},null,8,["model-value","onSubmit"])):(m(),T("div",Yt,[U(S(pt),{ref_key:"inputRef",ref:o,autosize:a.autoSize,type:Re.value,resize:"none",modelValue:S(_),"onUpdate:modelValue":w[0]||(w[0]=M=>at(_)?_.value=M:null),disabled:t.value,placeholder:a.placeholder,autofocus:a.autofocus,onKeydown:S(Te),onCompositionstart:w[1]||(w[1]=M=>F.value=!0),onCompositionend:C,onFocus:$e,onBlur:Me},null,8,["autosize","type","modelValue","disabled","placeholder","autofocus","onKeydown"]),S($)&&!S(F)?(m(),T("div",Zt,[z("span",Qt,re(S(_)),1),He(re(S($))+" ",1),S(Q)?(m(),T("div",Xt,"TAB")):W("",!0)])):W("",!0)]))]),D.value==="single"?(m(),T("div",en,[z("div",{class:"tiny-sender__buttons-container",ref_key:"buttonsContainerRef",ref:B},[ie(a.$slots,"actions",{},void 0,!0),U(je,{"allow-speech":a.allowSpeech,"allow-files":a.allowFiles,loading:a.loading,disabled:t.value,"show-clear":a.clearable,"has-content":q.value,"speech-status":S(oe),"button-group":a.buttonGroup,"submit-type":a.submitType,"is-over-limit":de.value,"stop-text":a.stopText,onClear:ge,onToggleSpeech:le,onSubmit:S(se),onCancel:w[2]||(w[2]=M=>a.$emit("cancel")),onTriggerSelect:S(E)},null,8,["allow-speech","allow-files","loading","disabled","show-clear","has-content","speech-status","button-group","submit-type","is-over-limit","stop-text","onSubmit","onTriggerSelect"])],512)])):W("",!0)],2),U(Fe,{name:"tiny-sender-slide-up"},{default:ce(()=>[D.value==="multiple"?(m(),T("div",tn,[z("div",nn,[ie(a.$slots,"footer-left",{},void 0,!0)]),z("div",an,[ie(a.$slots,"footer-right",{},void 0,!0),a.showWordLimit&&a.maxLength!==1/0?(m(),T("div",{key:0,class:ne(["tiny-sender__word-limit",{"is-over-limit":de.value}])},[z("span",on,re(S(_).length),1),He("/"+re(a.maxLength),1)],2)):W("",!0),D.value==="multiple"?(m(),T("div",ln,[z("div",sn,[U(je,{"allow-speech":a.allowSpeech,"allow-files":a.allowFiles,loading:a.loading,disabled:t.value,"show-clear":a.clearable,"has-content":q.value,"speech-status":S(oe),"button-group":a.buttonGroup,"submit-type":a.submitType,"is-over-limit":de.value,"stop-text":a.stopText,onClear:ge,onToggleSpeech:le,onSubmit:S(se),onCancel:w[3]||(w[3]=M=>a.$emit("cancel")),onTriggerSelect:S(E)},null,8,["allow-speech","allow-files","loading","disabled","show-clear","has-content","speech-status","button-group","submit-type","is-over-limit","stop-text","onSubmit","onTriggerSelect"])])])):W("",!0)])])):a.$slots.footer?(m(),T("div",rn,[ie(a.$slots,"footer",{},void 0,!0)])):W("",!0)]),_:3})],512)]),U(Nt,{show:S(h),suggestions:a.suggestions,"popup-style":d.value,"active-keyboard-index":S(k),"active-mouse-index":S(Y),"input-value":S(_),onSelect:S(x),onMouseEnter:S(ue),onMouseLeave:S(xe)},null,8,["show","suggestions","popup-style","active-keyboard-index","active-mouse-index","input-value","onSelect","onMouseEnter","onMouseLeave"])],10,zt))}}),Ee=be(un,[["__scopeId","data-v-5c7b4856"]]);Ee.name="TrSender";const dn=function(i){i.component(Ee.name,Ee)};Ee.install=dn;export{Ee as $};
