import{an as S,q as O,p as B,as as w}from"./framework.DeWfoKqf.js";var _=class{constructor(e){this.config=e}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}validateRequest(e){if(!e.messages||!Array.isArray(e.messages)||e.messages.length===0)throw new Error("请求必须包含至少一条消息");for(let i of e.messages)if(!i.role||!i.content)throw new Error("每条消息必须包含角色和内容")}},b=(e=>(e.NETWORK_ERROR="network_error",e.AUTHENTICATION_ERROR="authentication_error",e.RATE_LIMIT_ERROR="rate_limit_error",e.SERVER_ERROR="server_error",e.MODEL_ERROR="model_error",e.TIMEOUT_ERROR="timeout_error",e.UNKNOWN_ERROR="unknown_error",e))(b||{}),T=(e=>(e.DATA="data",e.ERROR="error",e.DONE="done",e))(T||{});function F(e){return{type:e.type||"unknown_error",message:e.message||"未知错误",statusCode:e.statusCode,originalError:e.originalError}}function R(e){var i;if(!e.response)return F({type:"network_error",message:"网络连接错误，请检查您的网络连接",originalError:e});if(e.response){let{status:r,data:l}=e.response;return r===401||r===403?F({type:"authentication_error",message:"身份验证失败，请检查您的API密钥",statusCode:r,originalError:e}):r===429?F({type:"rate_limit_error",message:"超出API调用限制，请稍后再试",statusCode:r,originalError:e}):r>=500?F({type:"server_error",message:"服务器错误，请稍后再试",statusCode:r,originalError:e}):F({type:"unknown_error",message:((i=l==null?void 0:l.error)==null?void 0:i.message)||`请求失败，状态码: ${r}`,statusCode:r,originalError:e})}return e.code==="ECONNABORTED"?F({type:"timeout_error",message:"请求超时，请稍后再试",originalError:e}):F({type:"unknown_error",message:e.message||"发生未知错误",originalError:e})}async function N(e,i,r){var p;let l=(p=e.body)==null?void 0:p.getReader();if(!l)throw new Error("Response body is null");let h=new TextDecoder,s="";r&&r.addEventListener("abort",()=>{l.cancel().catch(t=>console.error("Error cancelling reader:",t))},{once:!0});try{for(;;){if(r!=null&&r.aborted){await l.cancel();break}let{done:t,value:c}=await l.read();if(t)break;let d=h.decode(c,{stream:!0});s+=d;let f=s.split(`

`);s=f.pop()||"";for(let E of f)if(E.trim()!==""){if(E.trim()==="data: [DONE]"){i.onDone();continue}try{let v=E.match(/^data: (.+)$/m);if(!v)continue;let C=JSON.parse(v[1]);i.onData(C)}catch(v){console.error("Error parsing SSE message:",v)}}}(s.trim()==="data: [DONE]"||r!=null&&r.aborted)&&i.onDone()}catch(t){if(r!=null&&r.aborted)return;throw t}}var M=class extends _{constructor(e){super(e),this.defaultModel="gpt-3.5-turbo",this.baseURL=e.apiUrl||"https://api.openai.com/v1",this.apiKey=e.apiKey||"",e.defaultModel&&(this.defaultModel=e.defaultModel),this.apiKey||console.warn("API key is not provided. Authentication will likely fail.")}async chat(e){var i;try{this.validateRequest(e);let r={model:((i=e.options)==null?void 0:i.model)||this.config.defaultModel||this.defaultModel,messages:e.messages,...e.options,stream:!1},l={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)};this.apiKey&&Object.assign(l.headers,{Authorization:`Bearer ${this.apiKey}`});let h=await fetch(`${this.baseURL}/chat/completions`,l);if(!h.ok){let s=await h.text();throw new Error(`HTTP error! status: ${h.status}, details: ${s}`)}return await h.json()}catch(r){throw R(r)}}async chatStream(e,i){var h;let{signal:r,...l}=e.options||{};try{this.validateRequest(e);let s={model:((h=e.options)==null?void 0:h.model)||this.config.defaultModel||this.defaultModel,messages:e.messages,...l,stream:!0},p={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,Accept:"text/event-stream"},body:JSON.stringify(s),signal:r};this.apiKey&&Object.assign(p.headers,{Authorization:`Bearer ${this.apiKey}`});let t=await fetch(`${this.baseURL}/chat/completions`,p);if(!t.ok){let c=await t.text();throw new Error(`HTTP error! status: ${t.status}, details: ${c}`)}await N(t,i,r)}catch(s){if(r!=null&&r.aborted)return;i.onError(R(s))}}updateConfig(e){super.updateConfig(e),e.apiUrl&&(this.baseURL=e.apiUrl),e.apiKey&&(this.apiKey=e.apiKey),e.defaultModel&&(this.defaultModel=e.defaultModel)}},x=class{constructor(e){this.config=e,this.provider=this.createProvider(e)}createProvider(e){if(e.provider==="custom"&&"providerImplementation"in e)return e.providerImplementation;switch(e.provider){case"deepseek":let i={defaultModel:"deepseek-chat",apiUrl:"https://api.deepseek.com/v1"};return new M({...i,...e});case"openai":default:return new M(e)}}async chat(e){return this.provider.chat(e)}async chatStream(e,i){let r={...e,options:{...e.options,stream:!0}};return this.provider.chatStream(r,i)}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e},e.provider&&e.provider!==this.config.provider?this.provider=this.createProvider(this.config):this.provider.updateConfig(this.config)}},k=(e=>(e.INIT="init",e.PROCESSING="processing",e.STREAMING="streaming",e.FINISHED="finished",e.ABORTED="aborted",e.ERROR="error",e))(k||{}),I=["processing","streaming"];function K(e){let{client:i,useStreamByDefault:r=!0,errorMessage:l="请求失败，请稍后重试",initialMessages:h=[]}=e,s=B([...h]),p=B(""),t=B(r),c=null,d=S({status:"init",errorMsg:null}),f=u=>{var a;let g=(a=e.events)==null?void 0:a.onReceiveData,D=!1;if(g&&g(u,s,()=>{D=!0}),!D){let o={role:"assistant",content:u.choices[0].message.content};s.value.push(o)}},E=async u=>{let g=await i.chat({messages:w(s.value),options:{stream:!1,signal:u.signal}});f(g)},v=u=>{var a,o;let g=(a=e.events)==null?void 0:a.onReceiveData,D=!1;if(g&&g(u,s,()=>{D=!0}),!D){s.value[s.value.length-1].role==="user"&&s.value.push({role:"assistant",content:""});let n=(o=u.choices)==null?void 0:o[0];n&&n.delta.content&&(s.value[s.value.length-1].content+=n.delta.content)}},C=async u=>{await i.chatStream({messages:w(s.value),options:{stream:!0,signal:u.signal}},{onData:g=>{d.status="streaming",v(g)},onError:g=>{d.status="error",d.errorMsg=l,console.error("Stream request error:",g)},onDone:()=>{d.status="finished"}})},m=async()=>{d.status="processing",d.errorMsg=null,c=new AbortController;try{t.value?await C(c):await E(c),d.status="finished"}catch(u){d.errorMsg=l,d.status="error",console.error("Send message error:",u)}finally{c=null}};return{messages:s,messageState:d,inputMessage:p,useStream:t,sendMessage:async(u=p.value,g=!0)=>{if(I.includes(d.status)||!u||typeof u=="string"&&!u.trim()||Array.isArray(u)&&u.length===0)return;let D={role:"user",content:u};s.value.push(D),g&&(p.value=""),await m()},send:async()=>{I.includes(d.status)||await m()},clearMessages:()=>{s.value=[],d.errorMsg=null},addMessage:u=>{Array.isArray(u)?s.value.push(...u):s.value.push(u)},abortRequest:()=>{c&&(c.abort(),c=null,d.status="aborted")},retryRequest:async u=>{u===0||!s.value[u]||s.value[u].role==="user"||(s.value.splice(u),await m())}}}var P=class{constructor(e="tiny-robot-ai-conversations"){this.storageKey=e}saveConversations(e){try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(i){console.error("保存会话失败:",i)}}loadConversations(){try{let e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch(e){return console.error("加载会话失败:",e),[]}}};function U(){return Date.now().toString(36)+Math.random().toString(36).substring(2,9)}function q(e){let{client:i,storage:r=new P,autoSave:l=!0,allowEmpty:h=!1,useStreamByDefault:s=!0,errorMessage:p="请求失败，请稍后重试"}=e,t=S({conversations:[],currentId:null,loading:!1}),c=K({client:i,useStreamByDefault:s,errorMessage:p,initialMessages:[],events:e.events});O(()=>c.messages.value,a=>{if(t.currentId&&a.length>0){let o=t.conversations.findIndex(n=>n.id===t.currentId);o!==-1&&(t.conversations[o].messages=[...a],t.conversations[o].updatedAt=Date.now(),l&&m())}},{deep:!0});let d=(a="新会话",o={})=>{if(!h&&c.messages.value.length===0&&t.currentId)return t.currentId;let n=U(),y={id:n,title:a,createdAt:Date.now(),updatedAt:Date.now(),messages:[],metadata:o};return t.conversations.unshift(y),f(n),l&&m(),n},f=a=>{let o=t.conversations.find(n=>n.id===a);o&&(t.currentId=a,c.clearMessages(),o.messages.length>0&&o.messages.forEach(n=>c.addMessage(n)))},E=a=>{let o=t.conversations.findIndex(n=>n.id===a);o!==-1&&(t.conversations.splice(o,1),t.currentId===a&&(t.conversations.length>0?f(t.conversations[0].id):(t.currentId=null,c.clearMessages())),l&&m())},v=(a,o)=>{let n=t.conversations.find(y=>y.id===a);n&&(n.title=o,n.updatedAt=Date.now(),l&&m())},C=(a,o)=>{let n=t.conversations.find(y=>y.id===a);n&&(n.metadata={...n.metadata,...o},n.updatedAt=Date.now(),l&&m())},m=async()=>{try{await r.saveConversations(t.conversations)}catch(a){console.error("保存会话失败:",a)}},u=async()=>{t.loading=!0;try{let a=await r.loadConversations();t.conversations=a,a.length>0&&!t.currentId&&f(a[0].id)}catch(a){console.error("加载会话失败:",a)}finally{t.loading=!1}},g=async a=>{let o=t.conversations.find(n=>n.id===a);if(!o||o.messages.length<2)return(o==null?void 0:o.title)||"新会话";try{let n={role:"system",content:"请根据以下对话内容，生成一个简短的标题（不超过20个字符）。只需要返回标题文本，不需要任何解释或额外内容。"},y=o.messages.slice(0,Math.min(4,o.messages.length)),A=(await i.chat({messages:[n,...y],options:{stream:!1,max_tokens:30}})).choices[0].message.content.trim();return v(a,A),A}catch(n){return console.error("生成标题失败:",n),o.title}},D=()=>t.currentId&&t.conversations.find(a=>a.id===t.currentId)||null;return u(),{state:t,messageManager:c,createConversation:d,switchConversation:f,deleteConversation:E,updateTitle:v,updateMetadata:C,saveConversations:m,loadConversations:u,generateTitle:g,getCurrentConversation:D}}export{I as U,K as _,q as i,k as j,x as w};
