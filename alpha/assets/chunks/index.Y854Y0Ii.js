import{an as O,q as _,p as w,as as M}from"./framework.CSeOnaMy.js";var T=class{constructor(e){this.config=e}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}validateRequest(e){if(!e.messages||!Array.isArray(e.messages)||e.messages.length===0)throw new Error("请求必须包含至少一条消息");for(let n of e.messages)if(!n.role||!n.content)throw new Error("每条消息必须包含角色和内容")}},N=(e=>(e.NETWORK_ERROR="network_error",e.AUTHENTICATION_ERROR="authentication_error",e.RATE_LIMIT_ERROR="rate_limit_error",e.SERVER_ERROR="server_error",e.MODEL_ERROR="model_error",e.TIMEOUT_ERROR="timeout_error",e.UNKNOWN_ERROR="unknown_error",e))(N||{}),k=(e=>(e.DATA="data",e.ERROR="error",e.DONE="done",e))(k||{});function B(e){return{type:e.type||"unknown_error",message:e.message||"未知错误",statusCode:e.statusCode,originalError:e.originalError}}function I(e){var n;if(!e.response)return B({type:"network_error",message:"网络连接错误，请检查您的网络连接",originalError:e});if(e.response){let{status:t,data:c}=e.response;return t===401||t===403?B({type:"authentication_error",message:"身份验证失败，请检查您的API密钥",statusCode:t,originalError:e}):t===429?B({type:"rate_limit_error",message:"超出API调用限制，请稍后再试",statusCode:t,originalError:e}):t>=500?B({type:"server_error",message:"服务器错误，请稍后再试",statusCode:t,originalError:e}):B({type:"unknown_error",message:((n=c==null?void 0:c.error)==null?void 0:n.message)||`请求失败，状态码: ${t}`,statusCode:t,originalError:e})}return e.code==="ECONNABORTED"?B({type:"timeout_error",message:"请求超时，请稍后再试",originalError:e}):B({type:"unknown_error",message:e.message||"发生未知错误",originalError:e})}async function K(e,n,t){var r,g,m;let c=(r=e.body)==null?void 0:r.getReader();if(!c)throw new Error("Response body is null");let p=new TextDecoder,s="",f,d;t&&t.addEventListener("abort",()=>{c.cancel().catch(D=>console.error("Error cancelling reader:",D))},{once:!0});try{for(;;){if(t!=null&&t.aborted){await c.cancel();break}let{done:D,value:F}=await c.read();if(D)break;let A=p.decode(F,{stream:!0});s+=A;let E=s.split(`

`);s=E.pop()||"";for(let a of E)if(a.trim()!==""){if(a.trim()==="data: [DONE]"){d&&(f=d),n.onDone(f);continue}try{let o=a.match(/^data: (.+)$/m);if(!o)continue;let h=JSON.parse(o[1]);n.onData(h),d=((m=(g=h.choices)==null?void 0:g[0])==null?void 0:m.finish_reason)||void 0}catch(o){console.error("Error parsing SSE message:",o)}}}(s.trim()==="data: [DONE]"||t!=null&&t.aborted)&&(t!=null&&t.aborted&&(f="aborted"),n.onDone(f))}catch(D){if(t!=null&&t.aborted)return;throw D}}var S=class extends T{constructor(e){super(e),this.defaultModel="gpt-3.5-turbo",this.baseURL=e.apiUrl||"https://api.openai.com/v1",this.apiKey=e.apiKey||"",e.defaultModel&&(this.defaultModel=e.defaultModel),this.apiKey||console.warn("API key is not provided. Authentication will likely fail.")}async chat(e){var n;try{this.validateRequest(e);let t={model:((n=e.options)==null?void 0:n.model)||this.config.defaultModel||this.defaultModel,messages:e.messages,...e.options,stream:!1},c={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)};this.apiKey&&Object.assign(c.headers,{Authorization:`Bearer ${this.apiKey}`});let p=await fetch(`${this.baseURL}/chat/completions`,c);if(!p.ok){let s=await p.text();throw new Error(`HTTP error! status: ${p.status}, details: ${s}`)}return await p.json()}catch(t){throw I(t)}}async chatStream(e,n){var p;let{signal:t,...c}=e.options||{};try{this.validateRequest(e);let s={model:((p=e.options)==null?void 0:p.model)||this.config.defaultModel||this.defaultModel,messages:e.messages,...c,stream:!0},f={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,Accept:"text/event-stream"},body:JSON.stringify(s),signal:t};this.apiKey&&Object.assign(f.headers,{Authorization:`Bearer ${this.apiKey}`});let d=await fetch(`${this.baseURL}/chat/completions`,f);if(!d.ok){let r=await d.text();throw new Error(`HTTP error! status: ${d.status}, details: ${r}`)}await K(d,n,t)}catch(s){if(t!=null&&t.aborted)return;n.onError(I(s))}}updateConfig(e){super.updateConfig(e),e.apiUrl&&(this.baseURL=e.apiUrl),e.apiKey&&(this.apiKey=e.apiKey),e.defaultModel&&(this.defaultModel=e.defaultModel)}},q=class{constructor(e){this.config=e,this.provider=this.createProvider(e)}createProvider(e){if(e.provider==="custom"&&"providerImplementation"in e)return e.providerImplementation;switch(e.provider){case"deepseek":let n={defaultModel:"deepseek-chat",apiUrl:"https://api.deepseek.com/v1"};return new S({...n,...e});case"openai":default:return new S(e)}}async chat(e){return this.provider.chat(e)}async chatStream(e,n){let t={...e,options:{...e.options,stream:!0}};return this.provider.chatStream(t,n)}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e},e.provider&&e.provider!==this.config.provider?this.provider=this.createProvider(this.config):this.provider.updateConfig(this.config)}},P=(e=>(e.INIT="init",e.PROCESSING="processing",e.STREAMING="streaming",e.FINISHED="finished",e.ABORTED="aborted",e.ERROR="error",e))(P||{}),b=["processing","streaming"];function U(e){let{client:n,useStreamByDefault:t=!0,errorMessage:c="请求失败，请稍后重试",initialMessages:p=[]}=e,s=w([...p]),f=w(""),d=w(t),r=null,g=O({status:"init",errorMsg:null}),m=a=>{var v;let o=(v=e.events)==null?void 0:v.onReceiveData,h=!1;if(o&&o(a,s,()=>{h=!0}),!h){let y={role:"assistant",content:a.choices[0].message.content};s.value.push(y)}},D=async a=>{let o=await n.chat({messages:M(s.value),options:{stream:!1,signal:a.signal}});m(o)},F=a=>{var v,y;let o=(v=e.events)==null?void 0:v.onReceiveData,h=!1;if(o&&o(a,s,()=>{h=!0}),!h){s.value[s.value.length-1].role==="user"&&s.value.push({role:"assistant",content:""});let u=(y=a.choices)==null?void 0:y[0];u&&u.delta.content&&(s.value[s.value.length-1].content+=u.delta.content)}},A=async a=>{await n.chatStream({messages:M(s.value),options:{stream:!0,signal:a.signal}},{onData:o=>{g.status="streaming",F(o)},onError:o=>{g.status="error",g.errorMsg=c,console.error("Stream request error:",o)},onDone:o=>{var y;let h=(y=e.events)==null?void 0:y.onFinish,v=!1;if(h&&h(o,{messages:s,messageState:g},()=>{v=!0}),!v){if(o==="aborted"||g.status==="aborted")return;g.status="finished"}}})},E=async()=>{g.status="processing",g.errorMsg=null,r=new AbortController;try{d.value?await A(r):await D(r)}catch(a){g.errorMsg=c,g.status="error",console.error("Send message error:",a)}finally{r=null}};return{messages:s,messageState:g,inputMessage:f,useStream:d,sendMessage:async(a=f.value,o=!0)=>{if(b.includes(g.status)||!a||typeof a=="string"&&!a.trim()||Array.isArray(a)&&a.length===0)return;let h={role:"user",content:a};s.value.push(h),o&&(f.value=""),await E()},send:async()=>{b.includes(g.status)||await E()},clearMessages:()=>{s.value=[],g.errorMsg=null},addMessage:a=>{Array.isArray(a)?s.value.push(...a):s.value.push(a)},abortRequest:()=>{r&&(r.abort(),r=null,g.status="aborted")},retryRequest:async a=>{a===0||!s.value[a]||s.value[a].role==="user"||(s.value.splice(a),await E())}}}var $=class{constructor(e="tiny-robot-ai-conversations"){this.storageKey=e}saveConversations(e){try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(n){console.error("保存会话失败:",n)}}loadConversations(){try{let e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch(e){return console.error("加载会话失败:",e),[]}}};function x(){return Date.now().toString(36)+Math.random().toString(36).substring(2,9)}function j(e){let{client:n,storage:t=new $,autoSave:c=!0,allowEmpty:p=!1,useStreamByDefault:s=!0,errorMessage:f="请求失败，请稍后重试",events:d}=e,r=O({conversations:[],currentId:null,loading:!1}),g=!1,m=U({client:n,useStreamByDefault:s,errorMessage:f,initialMessages:[],events:{onReceiveData:d==null?void 0:d.onReceiveData,onFinish:d==null?void 0:d.onFinish}});_(()=>m.messages.value,u=>{if(r.currentId&&u.length>0){let l=r.conversations.findIndex(i=>i.id===r.currentId);l!==-1&&(r.conversations[l].messages=[...u],r.conversations[l].updatedAt=Date.now(),c&&o())}},{deep:!0});let D=(u="新会话",l={})=>{if(!p&&m.messages.value.length===0&&r.currentId)return r.currentId;let i=x(),C={id:i,title:u,createdAt:Date.now(),updatedAt:Date.now(),messages:[],metadata:l};return r.conversations.unshift(C),F(i),c&&o(),i},F=u=>{let l=r.conversations.find(i=>i.id===u);l&&(r.currentId=u,m.clearMessages(),l.messages.length>0&&l.messages.forEach(i=>m.addMessage(i)))},A=u=>{let l=r.conversations.findIndex(i=>i.id===u);l!==-1&&(r.conversations.splice(l,1),r.currentId===u&&(r.conversations.length>0?F(r.conversations[0].id):(r.currentId=null,m.clearMessages())),c&&o())},E=(u,l)=>{let i=r.conversations.find(C=>C.id===u);i&&(i.title=l,i.updatedAt=Date.now(),c&&o())},a=(u,l)=>{let i=r.conversations.find(C=>C.id===u);i&&(i.metadata={...i.metadata,...l},i.updatedAt=Date.now(),c&&o())},o=async()=>{try{await t.saveConversations(r.conversations)}catch(u){console.error("保存会话失败:",u)}},h=async()=>{r.loading=!0;try{let u=await t.loadConversations();r.conversations=u,u.length>0&&!r.currentId&&F(u[0].id),!g&&(d!=null&&d.onLoaded)&&(g=!0,d.onLoaded(u))}catch(u){console.error("加载会话失败:",u)}finally{r.loading=!1}},v=async u=>{let l=r.conversations.find(i=>i.id===u);if(!l||l.messages.length<2)return(l==null?void 0:l.title)||"新会话";try{let i={role:"system",content:"请根据以下对话内容，生成一个简短的标题（不超过20个字符）。只需要返回标题文本，不需要任何解释或额外内容。"},C=l.messages.slice(0,Math.min(4,l.messages.length)),R=(await n.chat({messages:[i,...C],options:{stream:!1,max_tokens:30}})).choices[0].message.content.trim();return E(u,R),R}catch(i){return console.error("生成标题失败:",i),l.title}},y=()=>r.currentId&&r.conversations.find(u=>u.id===r.currentId)||null;return h(),{state:r,messageManager:m,createConversation:D,switchConversation:F,deleteConversation:A,updateTitle:E,updateMetadata:a,saveConversations:o,loadConversations:h,generateTitle:v,getCurrentConversation:y}}export{P as F,b as _,U as k,j as l,q as x};
