import{an as S,q as O,p as C,as as A}from"./framework.eghS62D6.js";var I=class{constructor(e){this.config=e}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}validateRequest(e){if(!e.messages||!Array.isArray(e.messages)||e.messages.length===0)throw new Error("请求必须包含至少一条消息");for(let i of e.messages)if(!i.role||!i.content)throw new Error("每条消息必须包含角色和内容")}},_=(e=>(e.NETWORK_ERROR="network_error",e.AUTHENTICATION_ERROR="authentication_error",e.RATE_LIMIT_ERROR="rate_limit_error",e.SERVER_ERROR="server_error",e.MODEL_ERROR="model_error",e.TIMEOUT_ERROR="timeout_error",e.UNKNOWN_ERROR="unknown_error",e))(_||{}),b=(e=>(e.DATA="data",e.ERROR="error",e.DONE="done",e))(b||{});function E(e){return{type:e.type||"unknown_error",message:e.message||"未知错误",statusCode:e.statusCode,originalError:e.originalError}}function w(e){var i;if(!e.response)return E({type:"network_error",message:"网络连接错误，请检查您的网络连接",originalError:e});if(e.response){let{status:t,data:l}=e.response;return t===401||t===403?E({type:"authentication_error",message:"身份验证失败，请检查您的API密钥",statusCode:t,originalError:e}):t===429?E({type:"rate_limit_error",message:"超出API调用限制，请稍后再试",statusCode:t,originalError:e}):t>=500?E({type:"server_error",message:"服务器错误，请稍后再试",statusCode:t,originalError:e}):E({type:"unknown_error",message:((i=l==null?void 0:l.error)==null?void 0:i.message)||`请求失败，状态码: ${t}`,statusCode:t,originalError:e})}return e.code==="ECONNABORTED"?E({type:"timeout_error",message:"请求超时，请稍后再试",originalError:e}):E({type:"unknown_error",message:e.message||"发生未知错误",originalError:e})}async function T(e,i,t){var r;let l=(r=e.body)==null?void 0:r.getReader();if(!l)throw new Error("Response body is null");let h=new TextDecoder,s="";t&&t.addEventListener("abort",()=>{l.cancel().catch(d=>console.error("Error cancelling reader:",d))},{once:!0});try{for(;;){if(t!=null&&t.aborted){await l.cancel();break}let{done:d,value:p}=await l.read();if(d)break;let c=h.decode(p,{stream:!0});s+=c;let y=s.split(`

`);s=y.pop()||"";for(let v of y)if(v.trim()!==""){if(v.trim()==="data: [DONE]"){i.onDone();continue}try{let D=v.match(/^data: (.+)$/m);if(!D)continue;let f=JSON.parse(D[1]);i.onData(f)}catch(D){console.error("Error parsing SSE message:",D)}}}(s.trim()==="data: [DONE]"||t!=null&&t.aborted)&&i.onDone()}catch(d){if(t!=null&&t.aborted)return;throw d}}var R=class extends I{constructor(e){super(e),this.defaultModel="gpt-3.5-turbo",this.baseURL=e.apiUrl||"https://api.openai.com/v1",this.apiKey=e.apiKey||"",e.defaultModel&&(this.defaultModel=e.defaultModel),this.apiKey||console.warn("API key is not provided. Authentication will likely fail.")}async chat(e){var i;try{this.validateRequest(e);let t={model:((i=e.options)==null?void 0:i.model)||this.config.defaultModel||this.defaultModel,messages:e.messages,...e.options,stream:!1},l={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)};this.apiKey&&Object.assign(l.headers,{Authorization:`Bearer ${this.apiKey}`});let h=await fetch(`${this.baseURL}/chat/completions`,l);if(!h.ok){let s=await h.text();throw new Error(`HTTP error! status: ${h.status}, details: ${s}`)}return await h.json()}catch(t){throw w(t)}}async chatStream(e,i){var h;let{signal:t,...l}=e.options||{};try{this.validateRequest(e);let s={model:((h=e.options)==null?void 0:h.model)||this.config.defaultModel||this.defaultModel,messages:e.messages,...l,stream:!0},r={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,Accept:"text/event-stream"},body:JSON.stringify(s),signal:t};this.apiKey&&Object.assign(r.headers,{Authorization:`Bearer ${this.apiKey}`});let d=await fetch(`${this.baseURL}/chat/completions`,r);if(!d.ok){let p=await d.text();throw new Error(`HTTP error! status: ${d.status}, details: ${p}`)}await T(d,i,t)}catch(s){if(t!=null&&t.aborted)return;i.onError(w(s))}}updateConfig(e){super.updateConfig(e),e.apiUrl&&(this.baseURL=e.apiUrl),e.apiKey&&(this.apiKey=e.apiKey),e.defaultModel&&(this.defaultModel=e.defaultModel)}},$=class{constructor(e){this.config=e,this.provider=this.createProvider(e)}createProvider(e){if(e.provider==="custom"&&"providerImplementation"in e)return e.providerImplementation;switch(e.provider){case"deepseek":let i={defaultModel:"deepseek-chat",apiUrl:"https://api.deepseek.com/v1"};return new R({...i,...e});case"openai":default:return new R(e)}}async chat(e){return this.provider.chat(e)}async chatStream(e,i){let t={...e,options:{...e.options,stream:!0}};return this.provider.chatStream(t,i)}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e},e.provider&&e.provider!==this.config.provider?this.provider=this.createProvider(this.config):this.provider.updateConfig(this.config)}},N=(e=>(e.INIT="init",e.PROCESSING="processing",e.STREAMING="streaming",e.FINISHED="finished",e.ABORTED="aborted",e.ERROR="error",e))(N||{}),M=["processing","streaming"];function k(e){let{client:i,useStreamByDefault:t=!0,errorMessage:l="请求失败，请稍后重试",initialMessages:h=[]}=e,s=C([...h]),r=C(""),d=C(t),p=null,c=S({status:"init",errorMsg:null}),y=o=>{var u;let g=(u=e.events)==null?void 0:u.onReceiveData,a=!1;if(g&&g(o,s,()=>{a=!0}),!a){let n={role:"assistant",content:o.choices[0].message.content};s.value.push(n)}},v=async o=>{let g=await i.chat({messages:A(s.value),options:{stream:!1,signal:o.signal}});y(g)},D=o=>{var u,n;let g=(u=e.events)==null?void 0:u.onReceiveData,a=!1;if(g&&g(o,s,()=>{a=!0}),!a){s.value[s.value.length-1].role==="user"&&s.value.push({role:"assistant",content:""});let m=(n=o.choices)==null?void 0:n[0];m&&m.delta.content&&(s.value[s.value.length-1].content+=m.delta.content)}},f=async o=>{await i.chatStream({messages:A(s.value),options:{stream:!0,signal:o.signal}},{onData:g=>{c.status="streaming",D(g)},onError:g=>{c.status="error",c.errorMsg=l,console.error("Stream request error:",g)},onDone:()=>{c.status="finished"}})},F=async()=>{c.status="processing",c.errorMsg=null,p=new AbortController;try{d.value?await f(p):await v(p),c.status="finished"}catch(o){c.errorMsg=l,c.status="error",console.error("Send message error:",o)}finally{p=null}};return{messages:s,messageState:c,inputMessage:r,useStream:d,sendMessage:async(o=r.value,g=!0)=>{if(M.includes(c.status)||!o||typeof o=="string"&&!o.trim()||Array.isArray(o)&&o.length===0)return;let a={role:"user",content:o};s.value.push(a),g&&(r.value=""),await F()},send:async()=>{M.includes(c.status)||await F()},clearMessages:()=>{s.value=[],c.errorMsg=null},addMessage:o=>{Array.isArray(o)?s.value.push(...o):s.value.push(o)},abortRequest:()=>{p&&(p.abort(),p=null,c.status="aborted")},retryRequest:async o=>{o===0||!s.value[o]||s.value[o].role==="user"||(s.value.splice(o),await F())}}}var K=class{constructor(e="tiny-robot-ai-conversations"){this.storageKey=e}saveConversations(e){try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(i){console.error("保存会话失败:",i)}}loadConversations(){try{let e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch(e){return console.error("加载会话失败:",e),[]}}};function P(){return Date.now().toString(36)+Math.random().toString(36).substring(2,9)}function x(e){let{client:i,storage:t=new K,autoSave:l=!0,useStreamByDefault:h=!0,errorMessage:s="请求失败，请稍后重试"}=e,r=S({conversations:[],currentId:null,loading:!1}),d=k({client:i,useStreamByDefault:h,errorMessage:s,initialMessages:[],events:e.events});O(()=>d.messages.value,a=>{if(r.currentId&&a.length>0){let u=r.conversations.findIndex(n=>n.id===r.currentId);u!==-1&&(r.conversations[u].messages=[...a],r.conversations[u].updatedAt=Date.now(),l&&f())}},{deep:!0});let p=(a="新会话",u={})=>{let n=P(),m={id:n,title:a,createdAt:Date.now(),updatedAt:Date.now(),messages:[],metadata:u};return r.conversations.unshift(m),c(n),l&&f(),n},c=a=>{let u=r.conversations.find(n=>n.id===a);u&&(r.currentId=a,d.clearMessages(),u.messages.length>0&&u.messages.forEach(n=>d.addMessage(n)))},y=a=>{let u=r.conversations.findIndex(n=>n.id===a);u!==-1&&(r.conversations.splice(u,1),r.currentId===a&&(r.conversations.length>0?c(r.conversations[0].id):(r.currentId=null,d.clearMessages())),l&&f())},v=(a,u)=>{let n=r.conversations.find(m=>m.id===a);n&&(n.title=u,n.updatedAt=Date.now(),l&&f())},D=(a,u)=>{let n=r.conversations.find(m=>m.id===a);n&&(n.metadata={...n.metadata,...u},n.updatedAt=Date.now(),l&&f())},f=async()=>{try{await t.saveConversations(r.conversations)}catch(a){console.error("保存会话失败:",a)}},F=async()=>{r.loading=!0;try{let a=await t.loadConversations();r.conversations=a,a.length>0&&!r.currentId&&c(a[0].id)}catch(a){console.error("加载会话失败:",a)}finally{r.loading=!1}},o=async a=>{let u=r.conversations.find(n=>n.id===a);if(!u||u.messages.length<2)return(u==null?void 0:u.title)||"新会话";try{let n={role:"system",content:"请根据以下对话内容，生成一个简短的标题（不超过20个字符）。只需要返回标题文本，不需要任何解释或额外内容。"},m=u.messages.slice(0,Math.min(4,u.messages.length)),B=(await i.chat({messages:[n,...m],options:{stream:!1,max_tokens:30}})).choices[0].message.content.trim();return v(a,B),B}catch(n){return console.error("生成标题失败:",n),u.title}},g=()=>r.currentId&&r.conversations.find(a=>a.id===r.currentId)||null;return F(),{state:r,messageManager:d,createConversation:p,switchConversation:c,deleteConversation:y,updateTitle:v,updateMetadata:D,saveConversations:f,loadConversations:F,generateTitle:o,getCurrentConversation:g}}export{$ as O,M as U,k as _,x as i,N as j};
