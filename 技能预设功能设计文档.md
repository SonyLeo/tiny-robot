# 技能预设功能设计文档

## 1. 功能概述

在现有 Sender 组件基础上，新增**技能预设标签渲染能力**，组件接收外部传入的技能数据，在输入框最前方渲染技能标签，作为对话的上下文提示词。该功能需要与现有的模板编辑器（TemplateEditor）共存。

## 2. 核心需求

### 2.1 职责边界
- **组件内部**：只负责渲染技能标签、处理移除交互、组合消息
- **组件外部**：负责技能选择器 UI、技能列表管理、选择逻辑

### 2.2 基础交互
- 外部传入技能数据 → 组件在输入框最前方显示技能标签（蓝色背景）
- 标签右上角有移除按钮（×）
- 点击移除 → 触发事件通知外部
- 标签后可继续输入用户描述内容
- 发送时组合：`技能 prompt + 用户输入`

### 2.3 数据结构
```typescript
interface Skill {
  label: string           // 显示文本，如 "帮我写作"
  prompt: string          // 预设提示词
  placeholder?: string    // 可选：选中后的输入框占位符
}
```

### 2.4 约束条件
- **单选**：同时只能接收一个技能对象
- **必须输入**：只有技能不输入内容时无法发送
- **不持久化**：发送后清空技能选择
- **外部驱动**：技能内容完全由外部传入

### 2.5 与模板共存
- 技能标签和模板内容可以同时存在
- 布局顺序：`[技能标签] [模板内容] 用户输入`
- 两者互不干扰，独立管理

## 3. 技术方案

### 3.1 数据结构设计

#### 3.1.1 技能接口定义
```typescript
// types/skill.type.ts
export interface Skill {
  label: string           // 显示文本，如 "帮我写作"
  prompt: string          // 预设提示词，发送时会拼接到用户输入前
  placeholder?: string    // 可选：选中后的输入框占位符，用于引导用户输入
}
```

**设计说明**：
- `placeholder` 为可选属性，不强制要求
- 当提供时，会覆盖默认的输入框占位符
- 适用于需要特定输入格式或详细引导的场景
- 建议文本长度控制在 20 字以内，保持简洁

#### 3.1.2 Props 扩展
```typescript
// index.type.ts 中扩展 SenderProps
interface SenderProps {
  // ... 现有属性
  skill?: Skill | null  // 当前选中的技能（外部传入）
}
```

#### 3.1.3 Emits 扩展
```typescript
// 扩展 SenderEmits
interface SenderEmits {
  // ... 现有事件
  'skill-remove': []  // 用户点击移除按钮时触发
}
```

### 3.2 组件结构设计

#### 3.2.1 新增组件
```
components/
  └── SkillTag.vue          # 技能标签组件（唯一新增）
```

#### 3.2.2 布局结构
```html
<div class="sender-container">
  <!-- 输入区域 -->
  <div class="sender-input-wrapper">
    <!-- 技能标签 + 模板编辑器 + 输入框 -->
    <div class="sender-content-area">
      <!-- 1. 技能标签（最前方，外部传入数据） -->
      <SkillTag 
        v-if="props.skill"
        :skill="props.skill"
        @remove="handleRemoveSkill"
      />
      
      <!-- 2. 模板编辑器（中间） -->
      <TemplateEditor
        v-if="showTemplateEditor"
        :data="templateData"
        ...
      />
      
      <!-- 3. 用户输入框（后方） -->
      <textarea
        ref="inputRef"
        :placeholder="placeholder"
        ...
      />
    </div>
  </div>
  
  <!-- 操作按钮区域（不包含技能选择器） -->
  <ActionButtons>
    <!-- 文件上传、语音、提交等按钮 -->
  </ActionButtons>
</div>
```

### 3.3 状态管理

#### 3.3.1 主组件集成（简化版）
```typescript
// index.vue 中的 setup
const props = defineProps<SenderProps>()
const emit = defineEmits<SenderEmits>()

// 技能数据直接来自 props
const currentSkill = computed(() => props.skill)

// 是否有技能
const hasSkill = computed(() => !!currentSkill.value)

// 处理技能移除
const handleRemoveSkill = () => {
  emit('skill-remove')
  // 保持输入框聚焦
  nextTick(() => {
    inputRef.value?.focus()
  })
}
```

**说明**：
- 不需要内部状态管理，技能数据完全由外部通过 `props.skill` 传入
- 组件只负责渲染和触发移除事件
- 外部通过监听 `skill-remove` 事件来清空技能数据

### 3.4 发送逻辑改造

#### 3.4.1 消息组合策略
```typescript
// 在 handleSubmit 中
const handleSubmit = () => {
  const trimmedInput = inputValue.value.trim()
  
  // 验证：必须有用户输入
  if (!trimmedInput) {
    return
  }
  
  // 组合最终消息
  let finalMessage = trimmedInput
  
  // 1. 如果有技能，添加技能 prompt
  if (currentSkill.value) {
    finalMessage = `${currentSkill.value.prompt}\n\n${trimmedInput}`
  }
  
  // 2. 发送消息
  emit('submit', finalMessage)
  
  // 3. 清空状态
  clearInput()
  // 注意：不在组件内部清空技能，由外部监听 submit 事件后自行清空
}
```

#### 3.4.2 提交验证增强
```typescript
// 更新 canSubmit 计算属性
const canSubmit = computed(() => {
  // 必须有用户输入内容（纯文本部分）
  const hasUserInput = inputValue.value.trim().length > 0
  
  // 不能超出字数限制
  const notOverLimit = !isOverLimit.value
  
  // 不在加载状态
  const notLoading = !props.loading
  
  return hasUserInput && notOverLimit && notLoading
})
```

**说明**：
- 发送后不在组件内部清空技能
- 外部需要监听 `submit` 事件，发送成功后自行将 `skill` prop 设置为 `null`

### 3.5 UI 组件实现

#### 3.5.1 SkillTag 组件（唯一新增组件）
```vue
<!-- components/SkillTag.vue -->
<template>
  <div class="skill-tag">
    <span class="skill-tag__label">{{ skill.label }}</span>
    <button
      class="skill-tag__remove"
      type="button"
      aria-label="移除技能"
      @click.stop="handleRemove"
    >
      ×
    </button>
  </div>
</template>

<script setup lang="ts">
import type { Skill } from '../types/skill.type'

interface Props {
  skill: Skill
}

interface Emits {
  (e: 'remove'): void
}

defineProps<Props>()
const emit = defineEmits<Emits>()

const handleRemove = () => {
  emit('remove')
}
</script>

<style lang="less" scoped>
.skill-tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px 4px 10px;
  background: #3b82f6;
  color: white;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  flex-shrink: 0;
  user-select: none;
  
  &__label {
    line-height: 1.4;
  }
  
  &__remove {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    padding: 0;
    margin: 0;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 3px;
    color: white;
    font-size: 14px;
    line-height: 1;
    cursor: pointer;
    transition: background 0.15s;
    
    &:hover {
      background: rgba(255, 255, 255, 0.35);
    }
    
    &:active {
      background: rgba(255, 255, 255, 0.25);
    }
  }
}
</style>
```

**说明**：
- 移除了 `icon` 和 `readonly` 相关代码，保持最简设计
- 只保留 `label` 显示和移除按钮
- 外部如需图标，可以在 `label` 中包含 emoji 或通过插槽扩展

### 3.6 样式集成

#### 3.6.1 主容器布局调整
```less
// index.less 中添加
.sender-content-area {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 6px;
  width: 100%;
  
  // 技能标签
  .skill-tag {
    order: 1; // 最前
  }
  
  // 模板编辑器
  .template-editor {
    order: 2; // 中间
  }
  
  // 输入框
  textarea {
    order: 3; // 最后
    flex: 1;
    min-width: 120px;
  }
}
```

### 3.7 键盘交互增强

#### 3.7.1 快捷键支持
```typescript
// 在 useKeyboardHandler 中添加
const handleKeyPress = (e: KeyboardEvent) => {
  // ESC 键移除技能标签
  if (e.key === 'Escape' && currentSkill.value) {
    e.preventDefault()
    emit('skill-remove')
    return
  }
  
  // 其他键盘逻辑...
}
```

## 4. 与模板共存的处理

### 4.1 布局优先级
```
视觉顺序：[技能标签] [模板内容] 用户输入
DOM 顺序：使用 CSS order 控制
```

### 4.2 占位符逻辑
```typescript
const currentPlaceholder = computed(() => {
  // 优先级：技能占位符 > 模板占位符 > 默认占位符
  if (currentSkill.value?.placeholder) {
    return currentSkill.value.placeholder
  }
  if (showTemplateEditor.value) {
    return '继续输入...'
  }
  return props.placeholder || '输入消息...'
})
```

**说明**：
- 技能占位符优先级最高，可以为不同技能提供精准的输入引导
- 如果技能未提供 `placeholder`，则使用模板或默认占位符
- 这种设计既保持了灵活性，又不增加复杂度

### 4.3 消息组合策略
```typescript
const getFinalMessage = () => {
  let message = ''
  
  // 1. 技能 prompt
  if (currentSkill.value) {
    message += currentSkill.value.prompt + '\n\n'
  }
  
  // 2. 模板内容（如果有）
  if (templateContent.value) {
    message += templateContent.value + '\n\n'
  }
  
  // 3. 用户输入
  message += inputValue.value.trim()
  
  return message
}
```

### 4.4 清空逻辑
```typescript
const clearAll = () => {
  clearInput()      // 清空输入
  clearTemplate()   // 清空模板
  // 注意：技能由外部清空，不在组件内部处理
}
```

## 5. API 设计

### 5.1 Props
```typescript
interface SenderProps {
  // ... 现有属性
  
  // 技能相关（新增）
  skill?: Skill | null  // 当前选中的技能，外部传入
}
```

### 5.2 Events
```typescript
interface SenderEmits {
  // ... 现有事件
  
  // 技能相关（新增）
  'skill-remove': []  // 用户点击移除按钮时触发
}
```

### 5.3 Slots（可选扩展）
```typescript
// 可选：自定义技能标签渲染
<slot name="skill-tag" :skill="skill" :onRemove="handleRemoveSkill">
  <SkillTag :skill="skill" @remove="handleRemoveSkill" />
</slot>
```

## 6. 使用示例

### 6.1 基础使用（外部管理技能）
```vue
<template>
  <div>
    <!-- 技能选择器（外部实现） -->
    <div class="skill-selector">
      <button
        v-for="skill in skillList"
        :key="skill.label"
        @click="selectedSkill = skill"
      >
        {{ skill.label }}
      </button>
    </div>
    
    <!-- Sender 组件 -->
    <Sender
      v-model="message"
      :skill="selectedSkill"
      @submit="handleSubmit"
      @skill-remove="selectedSkill = null"
    />
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import type { Skill } from './types/skill.type'

const message = ref('')
const selectedSkill = ref<Skill | null>(null)

// 技能列表（外部定义）
const skillList: Skill[] = [
  {
    label: '翻译',
    prompt: '请帮我翻译以下内容：',
    placeholder: '输入需要翻译的文本'
  },
  {
    label: '帮我写作',
    prompt: '请根据以下要求帮我写作：',
    placeholder: '输入主题和写作要求'
  },
  {
    label: '编程',
    prompt: '请帮我编写代码：',
    placeholder: '描述你的编程需求'
  }
]

const handleSubmit = (text: string) => {
  console.log('发送消息:', text)
  // 调用 API...
  
  // 发送成功后清空技能
  selectedSkill.value = null
}
</script>
```

### 6.2 使用下拉菜单选择技能
```vue
<template>
  <div>
    <!-- 下拉菜单（外部实现） -->
    <select v-model="selectedSkill" @change="handleSkillChange">
      <option :value="null">选择技能...</option>
      <option
        v-for="skill in skillList"
        :key="skill.label"
        :value="skill"
      >
        {{ skill.label }}
      </option>
    </select>
    
    <!-- Sender 组件 -->
    <Sender
      v-model="message"
      :skill="selectedSkill"
      @submit="handleSubmit"
      @skill-remove="selectedSkill = null"
    />
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import type { Skill } from './types/skill.type'

const message = ref('')
const selectedSkill = ref<Skill | null>(null)

const skillList: Skill[] = [
  { 
    label: '翻译', 
    prompt: '请帮我翻译以下内容：',
    placeholder: '输入需要翻译的文本'
  },
  { 
    label: '总结', 
    prompt: '请总结以下内容的要点：',
    placeholder: '输入需要总结的内容'
  },
  { 
    label: '解释', 
    prompt: '请详细解释以下概念：',
    placeholder: '输入需要解释的概念'
  }
]

const handleSkillChange = () => {
  console.log('选择技能:', selectedSkill.value?.label)
}

const handleSubmit = (text: string) => {
  console.log('发送消息:', text)
  selectedSkill.value = null
}
</script>
```

### 6.3 与模板同时使用
```vue
<template>
  <div>
    <!-- 技能选择器 -->
    <button @click="selectedSkill = writeSkill">
      选择"帮我写作"技能
    </button>
    
    <!-- Sender 组件 -->
    <Sender
      v-model="message"
      :skill="selectedSkill"
      :template-data="templateData"
      @submit="handleSubmit"
      @skill-remove="selectedSkill = null"
    />
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import type { Skill } from './types/skill.type'

const message = ref('')
const selectedSkill = ref<Skill | null>(null)

const writeSkill: Skill = {
  label: '帮我写作',
  prompt: '请根据以下要求帮我写作：',
  placeholder: '输入主题和写作要求'
}

const templateData = [
  {
    id: '1',
    type: 'template',
    content: '@用户名',
    readonly: true
  }
]

const handleSubmit = (text: string) => {
  // text 将包含：技能 prompt + 模板内容 + 用户输入
  console.log('最终消息:', text)
  selectedSkill.value = null
}
</script>
```

### 6.4 集成到现有聊天应用
```vue
<template>
  <div class="chat-app">
    <!-- 消息列表 -->
    <div class="messages">
      <div v-for="msg in messages" :key="msg.id">
        {{ msg.text }}
      </div>
    </div>
    
    <!-- 技能快捷按钮 -->
    <div class="skill-shortcuts">
      <button
        v-for="skill in commonSkills"
        :key="skill.label"
        :class="{ active: selectedSkill?.label === skill.label }"
        @click="toggleSkill(skill)"
      >
        {{ skill.label }}
      </button>
    </div>
    
    <!-- 输入框 -->
    <Sender
      v-model="inputText"
      :skill="selectedSkill"
      :loading="isSending"
      @submit="sendMessage"
      @skill-remove="selectedSkill = null"
    />
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import type { Skill } from './types/skill.type'

const inputText = ref('')
const selectedSkill = ref<Skill | null>(null)
const isSending = ref(false)
const messages = ref<Array<{ id: number; text: string }>>([])

// 常用技能
const commonSkills: Skill[] = [
  { 
    label: '翻译', 
    prompt: '请帮我翻译：',
    placeholder: '输入需要翻译的文本'
  },
  { 
    label: '总结', 
    prompt: '请总结：',
    placeholder: '输入需要总结的内容'
  },
  { 
    label: '编程', 
    prompt: '请帮我编写代码：',
    placeholder: '描述你的编程需求'
  }
]

// 切换技能
const toggleSkill = (skill: Skill) => {
  if (selectedSkill.value?.label === skill.label) {
    selectedSkill.value = null
  } else {
    selectedSkill.value = skill
  }
}

// 发送消息
const sendMessage = async (text: string) => {
  isSending.value = true
  
  try {
    // 调用 API
    const response = await fetch('/api/chat', {
      method: 'POST',
      body: JSON.stringify({ message: text })
    })
    
    const data = await response.json()
    messages.value.push({
      id: Date.now(),
      text: data.reply
    })
    
    // 清空技能
    selectedSkill.value = null
  } catch (error) {
    console.error('发送失败:', error)
  } finally {
    isSending.value = false
  }
}
</script>
```

## 7. 实现优先级

### Phase 1: 核心功能（必须）
1. ✅ 数据结构定义（Skill 接口）
2. ✅ SkillTag 组件
3. ✅ Props 扩展（skill）
4. ✅ Events 扩展（skill-remove）
5. ✅ 主组件集成
6. ✅ 发送逻辑改造

### Phase 2: 交互优化（重要）
1. ✅ 键盘快捷键（ESC 移除）
2. ✅ 自动聚焦
3. ✅ 提交验证增强
4. ✅ 与模板共存布局

### Phase 3: 扩展功能（可选）
1. ⭕ 自定义插槽支持（skill-tag）
2. ⭕ 动画效果
3. ⭕ 主题适配

## 8. 测试要点

### 8.1 功能测试
- [ ] 点击技能后标签正确显示
- [ ] 移除按钮正常工作
- [ ] 只选择技能不输入内容时无法发送
- [ ] 发送后技能标签被清空
- [ ] 技能与模板可以同时存在
- [ ] 消息组合逻辑正确

### 8.2 交互测试
- [ ] ESC 键移除技能
- [ ] 点击技能后自动聚焦输入框
- [ ] 移除技能后保持输入框聚焦
- [ ] 占位符根据技能动态变化（如果提供了 placeholder）
- [ ] 未提供 placeholder 时使用默认占位符

### 8.3 边界测试
- [ ] 空技能列表
- [ ] 超长技能标签文本
- [ ] 快速切换技能
- [ ] 与其他功能（语音、文件上传）的兼容性

## 9. 注意事项

### 9.1 性能考虑
- 技能列表使用 `v-for` 时添加 `key`
- 避免在 `computed` 中进行复杂计算
- 菜单显示/隐藏使用 `v-if` 而非 `v-show`

### 9.2 可访问性
- 所有按钮添加 `aria-label`
- 支持键盘导航
- 确保颜色对比度符合 WCAG 标准

### 9.3 兼容性
- 确保与现有功能（模板、语音、建议）不冲突
- 保持 API 向后兼容
- 样式不影响现有布局

## 10. 架构优势

### 10.1 职责分离
- **组件内部**：专注于渲染和基础交互
- **组件外部**：负责业务逻辑和状态管理
- 符合单一职责原则

### 10.2 灵活性
- 外部可以自由实现任何形式的技能选择器（按钮、下拉、弹窗等）
- 技能列表可以来自任何数据源（硬编码、API、配置文件）
- 易于集成到不同的应用场景

### 10.3 可维护性
- 组件代码简洁，只关注核心功能
- 外部逻辑独立，易于测试和调试
- 减少组件内部复杂度

## 11. 占位符使用建议

### 11.1 何时使用 placeholder
- ✅ **需要特定格式输入**：如"输入格式：中文 -> 英文"
- ✅ **需要详细引导**：如"描述你的编程需求（语言、功能、场景）"
- ✅ **区分不同技能**：让用户明确当前应该输入什么类型的内容
- ❌ **技能标签已经很明确**：如"翻译"技能，可以不提供额外占位符

### 11.2 占位符文本规范
- 长度：建议 20 字以内，最多不超过 30 字
- 语气：简洁、友好、指令性
- 内容：明确告知用户应该输入什么
- 示例：
  - ✅ 好："输入需要翻译的文本"
  - ✅ 好："描述你的编程需求"
  - ❌ 差："请在这里输入您想要翻译的任何语言的文本内容"（过长）
  - ❌ 差："输入"（过于简单）

### 11.3 示例对比

```typescript
// 不提供 placeholder（适用于标签已经很明确的场景）
{
  label: '翻译',
  prompt: '请帮我翻译：'
  // 使用默认占位符 "输入消息..."
}

// 提供简单 placeholder（适用于需要基本引导的场景）
{
  label: '翻译',
  prompt: '请帮我翻译：',
  placeholder: '输入需要翻译的文本'
}

// 提供详细 placeholder（适用于需要特定格式的场景）
{
  label: '翻译',
  prompt: '请帮我翻译：',
  placeholder: '输入文本（支持中英互译）'
}
```

## 12. 后续扩展方向（外部实现）

以下功能由外部应用层实现，不在组件内部：

1. **技能选择器 UI**：按钮组、下拉菜单、弹窗等
2. **技能管理**：增删改查、分类、排序
3. **智能推荐**：根据上下文推荐合适的技能
4. **历史记录**：记录常用技能
5. **快捷键**：为常用技能分配快捷键（如 Ctrl+1, Ctrl+2）
6. **技能组合**：支持多个技能叠加（修改数据结构）
7. **动态占位符**：根据用户输入动态调整占位符提示

---
