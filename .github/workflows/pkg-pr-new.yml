# pkg.pr.new é¢„è§ˆå‘å¸ƒå·¥ä½œæµ
# é»˜è®¤ï¼šåªå‘å¸ƒåŒ…åˆ° pkg.pr.newï¼ˆå¿«é€Ÿï¼‰
# éœ€è¦é¢„è§ˆï¼šåœ¨ PR è¯„è®ºåŒºå›å¤ "/deploy-preview" è§¦å‘é¢„è§ˆéƒ¨ç½²
name: pkg.pr.new

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  push:
    branches: [main, develop]

jobs:
  publish:
    runs-on: ubuntu-latest
    # åªåœ¨ PR äº‹ä»¶æˆ– push äº‹ä»¶æ—¶æ‰§è¡Œï¼Œè¯„è®ºäº‹ä»¶è·³è¿‡
    if: |
      github.event_name != 'issue_comment' && (
        (github.event_name == 'push' && !contains(github.event.head_commit.message, 'docs:') && !contains(github.event.head_commit.message, 'chore: release')) ||
        (github.event_name == 'pull_request' && !contains(github.event.pull_request.title, 'docs:') && !contains(github.event.pull_request.title, 'chore: release'))
      )
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: Get pnpm store directory
        id: pnpm-cache
        run: |
          echo "pnpm_cache_dir=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Publish core packages to pkg.pr.new
        run: |
          npx pkg-pr-new publish \
            ./packages/components \
            ./packages/kit \
            ./packages/svgs \
            --pnpm \
            --template=.pkg-pr-new/template \
            --comment=update

      - name: Comment PR with usage tip
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const comment = `## ğŸ“¦ åŒ…é¢„è§ˆå·²å‘å¸ƒ
            
            ä½ çš„ PR åŒ…é¢„è§ˆå·²é€šè¿‡ pkg.pr.new å‘å¸ƒï¼ŒæŸ¥çœ‹ä¸Šæ–¹ pkg-pr-new bot çš„è¯„è®ºè·å–ï¼š
            - ğŸ“¦ åŒ…å®‰è£…å‘½ä»¤
            - ğŸ”— StackBlitz åœ¨çº¿é¢„è§ˆé“¾æ¥
            
            ---
            
            ğŸ’¡ **éœ€è¦å®Œæ•´æ–‡æ¡£é¢„è§ˆï¼Ÿ** åœ¨è¯„è®ºåŒºå›å¤ \`/deploy-docs\` å³å¯éƒ¨ç½²æ–‡æ¡£ç«™ç‚¹ã€‚`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

  deploy-docs:
    runs-on: ubuntu-latest
    # åªåœ¨ PR è¯„è®ºåŒ…å« "/deploy-docs" æ—¶æ‰§è¡Œ
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/deploy-docs')
    steps:
      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR branch
        id: pr_data
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);
            return pr.data.head.ref;

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_data.outputs.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get pnpm store directory
        id: pnpm-cache
        run: |
          echo "pnpm_cache_dir=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Build playground
        run: pnpm -F @opentiny/tiny-robot-playground build
        env:
          PLAYGROUND_BASE: /tiny-robot/pr-${{ github.event.issue.number }}/playground

      - name: Build docs
        run: pnpm -F docs build
        env:
          VITEPRESS_BASE: /tiny-robot/pr-${{ github.event.issue.number }}/

      - name: Copy playground to docs
        run: cp -r packages/playground/dist docs/dist/playground

      - name: Deploy docs preview
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/dist
          destination_dir: ./pr-${{ github.event.issue.number }}/
          keep_files: true
          force_orphan: false

      - name: Comment preview link
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            const docsUrl = `https://${repoOwner}.github.io/${repoName}/pr-${prNumber}/`;
            const playgroundUrl = `https://${repoOwner}.github.io/${repoName}/pr-${prNumber}/playground/`;
            
            const comment = `## ğŸ“š æ–‡æ¡£é¢„è§ˆå·²éƒ¨ç½²
            
            - **æ–‡æ¡£åœ°å€**: ${docsUrl}
            - **Playground**: ${playgroundUrl}
            - **æ›´æ–°æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
            
            > ğŸ’¡ å†æ¬¡å›å¤ \`/deploy-docs\` å¯é‡æ–°éƒ¨ç½²æœ€æ–°ä»£ç `;
            
            await github.rest.issues.createComment({
              owner: repoOwner,
              repo: repoName,
              issue_number: prNumber,
              body: comment
            });